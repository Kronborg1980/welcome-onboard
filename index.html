<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>NorrÃ¶na Onboard & Training</title>
    
    <link href="https://unpkg.com/material-icons@1.13.12/iconfont/material-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    
    <style>
        :root {
            --primary-dark: #002836;  
            --primary-brand: #004A59; 
            --accent-gold: #FCB900;   
            --accent-gold-hover: #e5a800;
            --text-main: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.65);
            --glass-bg: rgba(255, 255, 255, 0.06);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
            --card-radius: 20px;
            --nav-height: 75px;
            --danger: #e74c3c;
            --success: #27ae60;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--primary-dark); 
            color: var(--text-main); 
            background-image: radial-gradient(circle at 50% -20%, var(--primary-brand) 0%, var(--primary-dark) 70%); 
            background-attachment: fixed; 
            min-height: 100vh; 
            -webkit-font-smoothing: antialiased; 
            padding-bottom: env(safe-area-inset-bottom);
        }

        #app-shell { max-width: 480px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; padding-bottom: calc(var(--nav-height) + 30px); position: relative; overflow-x: hidden; }
        
        /* --- HEADER --- */
        .main-header { position: sticky; top: 0; z-index: 100; background: rgba(0, 40, 54, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid var(--glass-border); padding-top: env(safe-area-inset-top); }
        .navbar { display: flex; align-items: center; height: 60px; padding: 0 16px; gap: 10px; }
        .navbar .logo { flex-shrink: 0; display: flex; align-items: center; font-weight: 800; color: #fff; text-decoration: none; font-size: 1.2rem; }
        .onboard-time { flex-shrink: 0; font-weight: 600; font-size: 0.8rem; color: var(--text-main); opacity: 0.9; background: var(--glass-bg); padding: 6px 10px; border-radius: 50px; border: 1px solid var(--glass-border); white-space: nowrap; text-align: center; }
        .voyage-status { flex: 1; min-width: 0; display: flex; align-items: center; justify-content: center; gap: 6px; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(252, 185, 0, 0.25); padding: 6px 10px; border-radius: 50px; height: 36px; }
        .status-dot { flex-shrink: 0; width: 6px; height: 6px; background-color: var(--accent-gold); border-radius: 50%; box-shadow: 0 0 8px var(--accent-gold); animation: pulse 2s infinite; }
        #header-dest-text { font-size: 0.75rem; font-weight: 700; color: var(--accent-gold); text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        
        @media (max-width: 380px) {
            .navbar { padding: 0 10px; gap: 8px; }
            .onboard-time { font-size: 0.7rem; padding: 5px 8px; }
            .voyage-status { padding: 5px 8px; }
            #header-dest-text { font-size: 0.65rem; }
        }

        /* --- PAGES --- */
        .page { padding: 24px; display: none; animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        /* --- FRAMED VOYAGE MAP --- */
        .voyage-page.active { padding: 0; display: flex; flex-direction: column; }
        .voyage-map-container { position: relative; width: 100%; height: 40vh; z-index: 1; padding: 12px 12px 0 12px; }
        #map { width: 100%; height: 100%; background: #001e29; filter: saturate(0.8) contrast(1.1); border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.25); box-shadow: 0 4px 20px rgba(0,0,0,0.5), inset 0 0 40px rgba(0,0,0,0.8); overflow: hidden; }
        .map-gradient { position: absolute; bottom: 0; left: 13px; right: 13px; height: 40px; background: linear-gradient(to bottom, transparent, rgba(0, 40, 54, 0.6)); border-radius: 0 0 20px 20px; pointer-events: none; z-index: 2; }
        .voyage-sheet { position: relative; z-index: 10; margin-top: -16px; background: var(--primary-dark); border-radius: 24px 24px 0 0; border-top: 1px solid var(--glass-border); padding: 24px; box-shadow: 0 -10px 30px rgba(0,0,0,0.5); min-height: 60vh; }
        
        /* Grid & Components */
        .voyage-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .grid-item { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 16px; padding: 16px 12px; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100px; }
        .grid-item .label { font-size: 0.65rem; color: var(--accent-gold); opacity: 0.9; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 6px; font-weight: 700; }
        .grid-item .value { font-size: 1.3rem; font-weight: 600; color: #fff; letter-spacing: -0.5px; display: flex; align-items: baseline; justify-content: center; }
        .grid-item .value .unit { font-size: 0.7rem; opacity: 0.6; font-weight: 400; margin-left: 3px; text-transform: lowercase; }
        .grid-item .value .separator { font-size: 1.2rem; font-weight: 300; color: rgba(255,255,255,0.2); margin: 0 8px; }
        .grid-item .sub-value { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; font-weight: 300; display: flex; align-items: center; justify-content: center; gap: 6px; }

        .home-hero { height: 60vh; display: flex; flex-direction: column; justify-content: flex-end; padding: 32px; position: relative; border-radius: 0 0 40px 40px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.6); }
        .home-hero-bg { position: absolute; inset: 0; z-index: 1; background-size: cover; background-position: center; animation: slowZoom 24s infinite alternate ease-in-out; }
        .home-hero::after { content: ''; position: absolute; inset: 0; z-index: 2; background: linear-gradient(to top, var(--primary-dark) 10%, rgba(0,40,54,0.8) 35%, rgba(0,40,54,0) 70%); }
        .home-hero-content { position: relative; z-index: 3; text-align: center; margin-bottom: 20px; }
        .home-hero h1 { font-size: 3rem; line-height: 1.1; font-weight: 700; margin-bottom: 16px; text-shadow: 0 10px 30px rgba(0,0,0,0.8); letter-spacing: -1px; }
        .home-hero p { font-size: 1.1rem; color: rgba(255,255,255,0.9); margin: 0 auto; max-width: 90%; text-shadow: 0 2px 4px rgba(0,0,0,0.8); line-height: 1.5; }
        @keyframes slowZoom { from { transform: scale(1); } to { transform: scale(1.15); } }

        .bottom-nav { position: fixed; bottom: 24px; left: 24px; right: 24px; max-width: 432px; margin: 0 auto; height: var(--nav-height); background: rgba(0, 40, 54, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.15); border-radius: 24px; display: flex; justify-content: space-evenly; align-items: center; z-index: 1000; box-shadow: 0 20px 40px rgba(0,0,0,0.5); padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: rgba(255,255,255,0.4); text-decoration: none; font-size: 0.7rem; font-weight: 500; transition: all 0.3s ease; width: 60px; height: 100%; cursor: pointer;}
        .nav-item .material-icons { font-size: 24px; margin-bottom: 4px; transition: 0.3s; }
        .nav-item.active { color: #fff; }
        .nav-item.active .material-icons { color: var(--accent-gold); transform: translateY(-4px); filter: drop-shadow(0 0 8px rgba(252, 185, 0, 0.4)); }
        .nav-item.active::after { content: ''; width: 4px; height: 4px; background: var(--accent-gold); border-radius: 50%; position: absolute; bottom: 12px; }

        /* --- NEW: ONBOARDING / TRAINING MODULE STYLES --- */
        .onboarding-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: var(--glass-shadow); backdrop-filter: blur(10px); }
        .onboarding-header { text-align: center; margin-bottom: 25px; }
        .onboarding-header h2 { color: var(--accent-gold); font-size: 1.8rem; margin-bottom: 10px; }
        
        .dept-btn { display: block; width: 100%; padding: 16px; margin-bottom: 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 12px; color: #fff; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.3s; text-align: left; display: flex; align-items: center; gap: 15px; }
        .dept-btn:hover { background: rgba(252, 185, 0, 0.1); border-color: var(--accent-gold); }
        .dept-btn .material-icons { color: var(--accent-gold); }

        .slide-container { display: none; }
        .slide-container.active { display: block; animation: fadeIn 0.4s; }
        
        .training-img { width: 100%; height: 200px; object-fit: cover; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .training-text h3 { color: var(--accent-gold); margin-bottom: 10px; font-size: 1.4rem; }
        .training-text p, .training-text ul { color: rgba(255,255,255,0.9); margin-bottom: 15px; line-height: 1.6; }
        .training-text ul { padding-left: 20px; }
        .training-text li { margin-bottom: 8px; }

        .callout { background: rgba(252, 185, 0, 0.1); border-left: 4px solid var(--accent-gold); padding: 15px; border-radius: 0 8px 8px 0; margin-bottom: 15px; }

        /* FAQ Accordion inside Onboarding */
        .faq-item { background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); margin-bottom: 8px; border-radius: 8px; overflow: hidden; }
        .faq-q { padding: 15px; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: #fff; }
        .faq-a { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease; color: var(--text-muted); font-size: 0.95rem; }
        .faq-item.open .faq-a { padding: 15px; max-height: 500px; border-top: 1px solid rgba(255,255,255,0.05); }

        /* Quiz UI */
        .quiz-option { display: block; width: 100%; text-align: left; padding: 15px; margin-bottom: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 8px; color: #fff; font-size: 1rem; cursor: pointer; transition: 0.2s; }
        .quiz-option.selected { border-color: var(--accent-gold); background: rgba(252, 185, 0, 0.15); font-weight: bold; }
        .quiz-feedback { margin-top: 15px; font-weight: bold; text-align: center; padding: 10px; border-radius: 8px; display: none; }
        .feedback-success { background: rgba(39, 174, 96, 0.2); color: #2ecc71; border: 1px solid #27ae60; display: block; }
        .feedback-error { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c; display: block; }

        .nav-buttons { display: flex; justify-content: space-between; margin-top: 20px; gap: 10px; }
        .btn { padding: 14px 20px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; flex: 1; transition: 0.2s; text-align: center;}
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-primary { background: var(--accent-gold); color: var(--primary-dark); }
        .btn-primary:active { background: var(--accent-gold-hover); }

        /* Quiz Progress Bar */
        .train-progress { display: flex; gap: 4px; margin-bottom: 20px; }
        .train-step { flex: 1; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; }
        .train-step.active { background: var(--accent-gold); box-shadow: 0 0 5px var(--accent-gold); }

    </style>
</head>
<body>
    <div id="app-shell">
        <header class="main-header">
            <nav class="navbar">
                <a href="#" class="logo">SMYRIL LINE</a>
                <div class="voyage-status">
                    <span class="status-dot"></span>
                    <span id="header-dest-text">LOADING...</span>
                </div>
                <div class="onboard-time" id="onboard-time-header">--:--</div>
            </nav>
        </header>
        
        <main id="content-container"></main>
    </div>
    <nav class="bottom-nav" id="bottom-nav"></nav>
    
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // --- EMBEDDED DATA STRUCTURE (Replaces external data.json) ---
        const embeddedData = {
            "settings": {
                "logoUrl": "https://www.smyrilline.com/wp-content/themes/lunnar-smyrilline/images/logo.svg"
            },
            "categories": [
                {
                    "id": "home",
                    "title": "Welcome",
                    "icon": "home",
                    "type": "home",
                    "items": [
                        {
                            "name": "M/F NorrÃ¶na",
                            "description": "Connecting the North Atlantic. Welcome aboard our flagship.",
                            "images": ["https://www.smyrilline.com/wp-content/smush-webp/2025/04/Captains-9_1920x1325-1600x1104.jpg.webp"]
                        }
                    ]
                },
                {
                    "id": "voyage",
                    "title": "Voyage",
                    "icon": "explore",
                    "type": "voyage",
                    "items": []
                },
                {
                    "id": "onboarding",
                    "title": "Training",
                    "icon": "school",
                    "type": "training",
                    "items": []
                }
            ]
        };

        // --- TRAINING/ONBOARDING DATA ---
        const trainingContent = {
            all: [
                {
                    title: "The NorrÃ¶na Story",
                    img: "https://www.smyrilline.com/wp-content/smush-webp/2025/04/Captains-9_1920x1325-1600x1104.jpg.webp",
                    html: `
                        <h3>The Pride of the North Atlantic</h3>
                        <p>Welcome to the M/F NorrÃ¶na. You are joining a crew that operates the largest passenger ship in the North Atlantic.</p>
                        <ul>
                            <li><strong>Capacity:</strong> 1,482 Passengers & up to 120 Crew.</li>
                            <li><strong>Dimensions:</strong> 165 meters long, 30 meters wide.</li>
                            <li><strong>Cargo:</strong> 1,830 lane meters (up to 800 cars or 130 trailers).</li>
                        </ul>
                    `
                },
                {
                    title: "Safety & Culture",
                    img: "https://www.smyrilline.com/wp-content/smush-webp/2025/04/Engine_Room-56_1920x1325-1600x1104.jpg.webp",
                    html: `
                        <h3>"If you see it, you own it."</h3>
                        <p>Our safety vision is zero accidents. If you see a hazard, fix it or report it immediately via the <strong>SAFIR</strong> system found on deck iPads.</p>
                        <div class="callout">
                            <strong>Zero Tolerance:</strong> We have a strict 0-tolerance policy for alcohol and drugs. Violation means immediate dismissal.
                        </div>
                    `
                },
                {
                    title: "Frequently Asked Questions",
                    img: "",
                    html: `
                        <h3>Passenger FAQ</h3>
                        <p>Passengers will ask you these things constantly. Tap to learn the answers:</p>
                        <div class="faq-item" onclick="toggleFaq(this)">
                            <div class="faq-q">Where do we sail? <span class="material-icons">expand_more</span></div>
                            <div class="faq-a">We run from Hirtshals (DK) âž” TÃ³rshavn (FO) âž” SeyÃ°isfjÃ¶rÃ°ur (IS).</div>
                        </div>
                        <div class="faq-item" onclick="toggleFaq(this)">
                            <div class="faq-q">How long is the crossing? <span class="material-icons">expand_more</span></div>
                            <div class="faq-a">Denmark to Faroes takes ~30-38 hours. Faroes to Iceland is an extra 15 hours.</div>
                        </div>
                        <div class="faq-item" onclick="toggleFaq(this)">
                            <div class="faq-q">What's the crew schedule? <span class="material-icons">expand_more</span></div>
                            <div class="faq-a">We work a 1:1 schedule. e.g., 4 weeks onboard, followed by 4 weeks paid leave at home.</div>
                        </div>
                    `
                }
            ],
            hotel: [
                {
                    title: "Hotel & Commercial",
                    img: "https://www.smyrilline.com/wp-content/smush-webp/2025/04/QQL8303-1920x1325-1-1600x1104.jpg.webp",
                    html: `
                        <h3>The Guest Experience</h3>
                        <p>We turn a ferry ride into a cruise experience.</p>
                        <div class="callout">
                            <strong>The 60-Second Rule:</strong> Always acknowledge and greet guests within 60 seconds of their arrival.
                        </div>
                        <ul>
                            <li><strong>Shoes:</strong> Bring your own all-black, closed-toe, non-slip shoes (no logos).</li>
                            <li><strong>Tax-Free:</strong> Crew can only use the shop during designated "Crew Sale" hours.</li>
                        </ul>
                    `
                }
            ],
            deck: [
                {
                    title: "Deck Operations",
                    img: "https://www.smyrilline.com/wp-content/smush-webp/2025/04/Deck-56_1920x1325-1600x1104.jpg.webp",
                    html: `
                        <h3>Cargo & Exterior</h3>
                        <p>We handle the lifeblood of the ship: vehicles and cargo.</p>
                        <ul>
                            <li><strong>High Risk:</strong> Hazards are highest during loading/unloading. A task supervisor must always be present.</li>
                            <li><strong>Certificates:</strong> Smyril Line pays for STCW renewals, but it is <em>your</em> responsibility to book them before they expire.</li>
                        </ul>
                    `
                }
            ],
            engine: [
                {
                    title: "Engine Department",
                    img: "https://www.smyrilline.com/wp-content/smush-webp/2025/04/Engine_Room-56_1920x1325-1600x1104.jpg.webp",
                    html: `
                        <h3>The Heartbeat</h3>
                        <p>We power the beast with 4 WÃ¤rtsilÃ¤ NSD ZA40S engines pushing 30,000 HP.</p>
                        <ul>
                            <li><strong>Safety:</strong> Hearing protection and PPE are non-negotiable in the engine room.</li>
                            <li><strong>Efficiency:</strong> Surplus engine heat is used to warm the passenger hot tubs on deck!</li>
                        </ul>
                    `
                }
            ]
        };

        const quizBank = {
            general: [
                { q: "What does the SAFIR system handle?", options: ["Food orders", "Passenger tickets", "Reporting accidents & near misses"], ans: 2 },
                { q: "What is our policy on alcohol?", options: ["1 drink allowed off-duty", "Zero-tolerance", "Allowed in cabins"], ans: 1 },
                { q: "What is the core rule of our safety culture?", options: ["If you see it, you own it", "The captain fixes it", "Ignore small issues"], ans: 0 }
            ],
            hotel: [
                { q: "What is the '60-Second Rule'?", options: ["Clean tables in 60s", "Acknowledge guests within 60s", "Serve drinks in 60s"], ans: 1 },
                { q: "What type of shoes MUST you bring?", options: ["White sneakers", "All-black, non-slip, closed-toe", "Sandals"], ans: 1 }
            ],
            deck: [
                { q: "When are hazards highest for the Deck department?", options: ["Open ocean sailing", "During safety drills", "During loading/unloading"], ans: 2 },
                { q: "Who is responsible for renewing your STCW certificates?", options: ["The Captain", "You are", "The port authority"], ans: 1 }
            ],
            engine: [
                { q: "What is absolutely non-negotiable in the engine room?", options: ["Wearing a tie", "Hearing protection and PPE", "Running to save time"], ans: 1 },
                { q: "What is surplus engine heat used for?", options: ["Heating passenger hot tubs", "Cooking in the galley", "Melting deck ice"], ans: 0 }
            ]
        };

        // --- APP STATE ---
        let map;
        let liveRouteLine = null;
        let appData = embeddedData; // Use embedded data directly
        
        // Training State
        let currentDept = '';
        let trainingSlides = [];
        let currentTrainIdx = 0;
        let activeQuizQuestions = [];
        let currentQuizIdx = 0;
        let selectedQuizAns = null;

        document.addEventListener("DOMContentLoaded", () => {
            initApp();
            setInterval(updateShipData, 60000); 
            setInterval(updateHeaderTime, 1000);
        });

        function initApp() {
            // Setup Bottom Nav
            const navHtml = appData.categories.map(cat => `<a href="#${cat.id}" class="nav-item" data-id="${cat.id}"><span class="material-icons">${cat.icon}</span>${cat.title}</a>`).join('');
            document.getElementById("bottom-nav").innerHTML = navHtml;
            
            document.querySelectorAll('.nav-item').forEach(link => { 
                link.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    renderPage(e.currentTarget.dataset.id); 
                }); 
            });
            
            // Check hash or load home
            const initialPageId = window.location.hash.substring(1);
            if (initialPageId && appData.categories.some(c => c.id === initialPageId)) {
                renderPage(initialPageId);
            } else {
                renderPage('home'); 
            }
        }

        // --- RENDER PAGES ---
        function renderPage(pageId) {
            const contentContainer = document.getElementById("content-container");
            const page = appData.categories.find(cat => cat.id === pageId);
            
            // Update Active Nav Icon
            document.querySelectorAll('.nav-item').forEach(link => link.classList.toggle('active', link.dataset.id === pageId));
            
            if (page.type === 'home') {
                renderHome(contentContainer, page);
                updateShipData(true);
            } else if (page.type === 'voyage') {
                renderVoyage(contentContainer);
                initializeVoyagePage();
            } else if (page.type === 'training') {
                renderTraining(contentContainer);
            }
            
            window.location.hash = pageId;
        }

        function renderHome(container, page) {
            const heroItem = page.items[0];
            container.innerHTML = `
                <div class="page active" style="padding:0;">
                    <div class="home-hero">
                        <div class="home-hero-bg" style="background-image: url(${heroItem.images[0]})"></div>
                        <div class="home-hero-content">
                            <h1>${heroItem.name}</h1>
                            <p>${heroItem.description}</p>
                        </div>
                    </div>
                    <div style="padding:24px;">
                        <div class="voyage-grid">
                            <div class="grid-item">
                                <div id="home-dest-label" class="label">Next Stop</div>
                                <div class="value" id="destination-home" style="font-size:1.6rem">--</div>
                                <div class="sub-value" id="eta-home">--</div>
                            </div>
                            <div class="grid-item">
                                <div class="label">Speed & Course</div>
                                <div class="value" style="font-size: 1.2rem;">
                                    <span id="speed-knots-home">--</span> <span class="unit">kn</span>
                                </div>
                                <div class="sub-value" id="course-home">Course: --Â°</div>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function renderVoyage(container) {
            container.innerHTML = `
                <div class="page active voyage-page" style="padding:0">
                    <div class="voyage-map-container">
                        <div id="map"></div>
                        <div class="map-gradient"></div>
                    </div>
                    <div class="voyage-sheet">
                        <div class="weather-strip">
                            <div class="weather-left">
                                <img id="weather-icon" src="" alt="">
                                <div class="weather-details">
                                    <div class="weather-temp" id="weather-temp">--Â°C</div>
                                    <div class="weather-desc" id="weather-description">--</div>
                                </div>
                            </div>
                            <div class="weather-label">Destination<br>Weather</div>
                        </div>
                        <div class="voyage-grid">
                            <div class="grid-item">
                                <div class="label">Speed</div>
                                <div class="value"><span id="speed-knots">--</span> <span class="unit">kn</span></div>
                                <div class="sub-value" id="course-voyage">Course: --Â°</div>
                            </div>
                            <div class="grid-item">
                                <div class="label">Time (TÃ³rshavn)</div>
                                <div class="value" id="onboard-time" style="font-size:1.5rem">--:--</div>
                                <div class="sub-value">GMT</div>
                            </div>
                            <div class="grid-item">
                                <div class="label">Distance Left</div>
                                <div class="value" id="distance" style="font-size:1.5rem">--</div>
                                <div class="sub-value" id="distance-unit">Km</div>
                            </div>
                            <div class="grid-item">
                                <div class="label" id="destination-label">Destination</div>
                                <div class="value" id="destination-voyage" style="font-size:1.2rem">--</div>
                                <div class="sub-value" id="eta-voyage">--</div>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        // --- NEW TRAINING MODULE LOGIC ---
        function renderTraining(container) {
            container.innerHTML = `
                <div class="page active" style="padding-bottom: 80px;">
                    <div class="onboarding-card" id="train-selector">
                        <div class="onboarding-header">
                            <h2>Welcome Onboard</h2>
                            <p style="color:var(--text-muted)">Select your department to begin your mandatory familiarization training.</p>
                        </div>
                        <button class="dept-btn" onclick="startTraining('hotel')"><span class="material-icons">room_service</span> Hotel & Commercial</button>
                        <button class="dept-btn" onclick="startTraining('deck')"><span class="material-icons">anchor</span> Deck Department</button>
                        <button class="dept-btn" onclick="startTraining('engine')"><span class="material-icons">engineering</span> Engine Department</button>
                    </div>

                    <div class="onboarding-card slide-container" id="train-viewer">
                        <div class="train-progress" id="train-progress"></div>
                        <div id="train-content"></div>
                        <div class="nav-buttons" id="train-nav">
                            <button class="btn btn-secondary" id="train-back" onclick="prevTrainSlide()">Back</button>
                            <button class="btn btn-primary" id="train-next" onclick="nextTrainSlide()">Next</button>
                        </div>
                    </div>
                </div>`;
        }

        window.startTraining = function(dept) {
            currentDept = dept;
            document.getElementById('train-selector').style.display = 'none';
            document.getElementById('train-viewer').classList.add('active');
            
            // Build slides
            trainingSlides = [...trainingContent.all, ...trainingContent[dept]];
            
            // Build Quiz (General + Dept)
            activeQuizQuestions = [...quizBank.general, ...quizBank[dept]].sort(() => Math.random() - 0.5);
            
            // Add a final 'Quiz Intro' slide
            trainingSlides.push({ isQuizIntro: true });
            
            currentTrainIdx = 0;
            renderTrainSlide();
        }

        function renderTrainSlide() {
            const slide = trainingSlides[currentTrainIdx];
            const contentDiv = document.getElementById('train-content');
            
            // Update Progress Bar
            const progDiv = document.getElementById('train-progress');
            progDiv.innerHTML = trainingSlides.map((_, i) => `<div class="train-step ${i <= currentTrainIdx ? 'active' : ''}"></div>`).join('');

            // Nav buttons state
            document.getElementById('train-back').style.display = currentTrainIdx === 0 ? 'none' : 'block';
            const btnNext = document.getElementById('train-next');
            btnNext.innerText = "Next";
            btnNext.onclick = nextTrainSlide;

            if (slide.isQuizIntro) {
                contentDiv.innerHTML = `
                    <div class="training-text" style="text-align:center; padding: 20px 0;">
                        <h3 style="font-size:2rem; margin-bottom:15px;">Clearance Test</h3>
                        <p>You have reviewed the material. Now you must pass the assessment to complete onboarding.</p>
                        <span class="material-icons" style="font-size: 60px; color: var(--accent-gold); margin: 20px 0;">assignment</span>
                    </div>
                `;
                btnNext.innerText = "Start Quiz";
                btnNext.onclick = startQuiz;
            } else {
                contentDiv.innerHTML = `
                    ${slide.img ? `<img src="${slide.img}" class="training-img">` : ''}
                    <div class="training-text">
                        ${slide.html}
                    </div>
                `;
            }
        }

        window.nextTrainSlide = function() {
            if (currentTrainIdx < trainingSlides.length - 1) {
                currentTrainIdx++;
                renderTrainSlide();
            }
        }

        window.prevTrainSlide = function() {
            if (currentTrainIdx > 0) {
                currentTrainIdx--;
                renderTrainSlide();
            }
        }

        window.toggleFaq = function(el) {
            el.classList.toggle('open');
            const icon = el.querySelector('.material-icons');
            icon.innerText = el.classList.contains('open') ? 'expand_less' : 'expand_more';
        }

        // -- QUIZ LOGIC --
        function startQuiz() {
            currentQuizIdx = 0;
            renderQuizQuestion();
        }

        function renderQuizQuestion() {
            const q = activeQuizQuestions[currentQuizIdx];
            const contentDiv = document.getElementById('train-content');
            
            // Hide progress dots during quiz
            document.getElementById('train-progress').innerHTML = '';
            document.getElementById('train-back').style.display = 'none';
            
            let optionsHtml = q.options.map((opt, idx) => 
                `<button class="quiz-option" onclick="selectQuizOption(this, ${idx})">${opt}</button>`
            ).join('');

            contentDiv.innerHTML = `
                <div class="training-text">
                    <div style="color:var(--text-muted); font-size:0.8rem; margin-bottom:10px; text-transform:uppercase;">Question ${currentQuizIdx + 1} of ${activeQuizQuestions.length}</div>
                    <h3 style="color:#fff;">${q.q}</h3>
                    <div style="margin-top:20px;">${optionsHtml}</div>
                    <div id="quiz-feedback" class="quiz-feedback"></div>
                </div>
            `;

            selectedQuizAns = null;
            const btnNext = document.getElementById('train-next');
            btnNext.innerText = "Submit Answer";
            btnNext.style.display = 'block';
            btnNext.onclick = checkQuizAnswer;
        }

        window.selectQuizOption = function(btn, idx) {
            document.querySelectorAll('.quiz-option').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedQuizAns = idx;
            document.getElementById('quiz-feedback').style.display = 'none';
        }

        function checkQuizAnswer() {
            const feedback = document.getElementById('quiz-feedback');
            if (selectedQuizAns === null) {
                feedback.innerText = "Please select an answer.";
                feedback.className = "quiz-feedback feedback-error";
                return;
            }

            const q = activeQuizQuestions[currentQuizIdx];
            if (selectedQuizAns === q.ans) {
                feedback.innerText = "Correct! âœ…";
                feedback.className = "quiz-feedback feedback-success";
                document.getElementById('train-next').style.display = 'none';
                
                setTimeout(() => {
                    currentQuizIdx++;
                    if (currentQuizIdx >= activeQuizQuestions.length) {
                        showTrainingSuccess();
                    } else {
                        renderQuizQuestion();
                    }
                }, 1000);
            } else {
                feedback.innerText = "Incorrect. Try again!";
                feedback.className = "quiz-feedback feedback-error";
            }
        }

        function showTrainingSuccess() {
            const contentDiv = document.getElementById('train-content');
            document.getElementById('train-nav').style.display = 'none';
            
            const deptNames = { hotel: "Hotel & Commercial", deck: "Deck Ops", engine: "Engine & Tech" };

            contentDiv.innerHTML = `
                <div style="text-align:center; padding: 20px 0;">
                    <h2 style="color:var(--success); margin-bottom:10px;">Clearance Granted!</h2>
                    <div style="background:rgba(39, 174, 96, 0.1); border: 1px solid var(--success); padding: 20px; border-radius: 12px; margin-top:20px;">
                        <p style="color:var(--text-muted); font-size:0.8rem; text-transform:uppercase;">Digital Boarding Pass</p>
                        <div style="font-size:3rem; margin:10px 0;">ðŸŽ«</div>
                        <h3 style="color:#fff;">M/F NorrÃ¶na</h3>
                        <p style="color:var(--accent-gold); font-weight:bold;">${deptNames[currentDept]}</p>
                        <p style="color:var(--success); margin-top:10px; font-weight:bold;">CLEARED TO EMBARK</p>
                    </div>
                </div>
            `;
        }

        // --- GLOBAL HELPERS & MAP LOGIC ---
        function updateHeaderTime() { 
            const el = document.getElementById('onboard-time-header');
            if(el) el.textContent = new Date().toLocaleTimeString('en-GB', { timeZone: 'Atlantic/Faroe', hour: '2-digit', minute: '2-digit' }); 
        }
        
        function normalizeDestinationName(e) { return e ? e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/Ã°/g, "d").replace(/[^a-z0-9]/g, "") : "" }
        function haversineDistance(e,t,o,a){const n=6371,r=(o-e)*Math.PI/180,i=(a-t)*Math.PI/180,s=Math.sin(r/2)*Math.sin(r/2)+Math.cos(e*Math.PI/180)*Math.cos(o*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 2*n*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))}
        function formatETA(e) { if (!e) return null; try { const t = new Date(e); if (isNaN(t.getTime())) return null; const o = t.toLocaleDateString("en-GB", { weekday: "short", timeZone: "Atlantic/Faroe" }); const a = t.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit", hour12: !1, timeZone: "Atlantic/Faroe" }); return { day: o, time: a }; } catch (e) { return null; } }
        
        const destinationMap = { 
            torshavn: { name: "TÃ³rshavn", lat: 62.0080, lon: -6.7705 }, 
            hirtshals: { name: "Hirtshals", lat: 57.5915, lon: 9.9620 }, 
            seydisfjord: { name: "SeyÃ°isfjÃ¶rÃ°ur", lat: 65.2595, lon: -14.0090 } 
        };

        const createShipIcon = (course) => {
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FCB900" stroke="#002836" stroke-width="2" stroke-linejoin="round"><path d="M12 2L19 21L12 17L5 21L12 2Z"/></svg>`;
            return L.divIcon({ className: 'ship-marker-container', html: `<div style="transform: rotate(${course}deg); width: 30px; height: 30px; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));">${svg}</div>`, iconSize: [30, 30], iconAnchor: [15, 15] });
        };
        const pinIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', iconSize: [25, 41], iconAnchor: [12, 41] });

        async function updateShipData(isHomePage = false) {
            try {
                const response = await fetch("https://smyrillinewebapi-cec3fkhjh8bbhtd3.northeurope-01.azurewebsites.net/vessel/vessels");
                const norrona = (await response.json()).find(v => v.vesselName?.toUpperCase() === 'NORRONA');
                if (!norrona) return;

                const speedKnots = norrona.position?.speed || 0;
                const course = Math.round(norrona.position?.course || 0);
                const currentDestKey = normalizeDestinationName(norrona.destinationFromAIS.split(",")[0].trim());
                const currentDestInfo = destinationMap[currentDestKey] || destinationMap['torshavn'];
                const dist = haversineDistance(norrona.position.latitude, norrona.position.longitude, currentDestInfo.lat, currentDestInfo.lon);
                const isInPort = speedKnots < 1.0 && dist < 2.0;

                const headerTextEl = document.getElementById('header-dest-text');
                const arrivalTime = formatETA(norrona.etaFromAIS);

                if (isInPort) headerTextEl.innerHTML = `In ${currentDestInfo.name}`;
                else headerTextEl.innerHTML = arrivalTime ? `To ${currentDestInfo.name} &bull; ${arrivalTime.day}` : `To ${currentDestInfo.name}`;

                if (isHomePage) {
                    const elDest = document.getElementById('destination-home');
                    if(elDest) {
                        document.getElementById('home-dest-label').textContent = isInPort ? "Current Status" : "Next Stop";
                        elDest.textContent = isInPort ? "In Harbor" : currentDestInfo.name;
                        document.getElementById('eta-home').textContent = arrivalTime ? `${arrivalTime.day}, ${arrivalTime.time}` : '--';
                        document.getElementById('speed-knots-home').textContent = speedKnots.toFixed(1);
                        document.getElementById('course-home').textContent = `Course: ${course}Â°`;
                    }
                } else {
                    const page = document.querySelector('.voyage-page'); 
                    if(page) {
                        document.getElementById("speed-knots").textContent = speedKnots.toFixed(1); 
                        document.getElementById("course-voyage").textContent = `Course: ${course}Â°`;
                        
                        if (isInPort) {
                            document.getElementById("distance").textContent = "Docked"; 
                            document.getElementById("distance-unit").textContent = "";
                            document.getElementById("destination-label").textContent = "Location";
                            document.getElementById("destination-voyage").textContent = currentDestInfo.name;
                            document.getElementById("eta-voyage").textContent = "Arrived";
                        } else {
                            document.getElementById("distance").textContent = Math.round(dist); 
                            document.getElementById("distance-unit").textContent = "Km";
                            document.getElementById("destination-label").textContent = "Destination";
                            document.getElementById("destination-voyage").textContent = currentDestInfo.name;
                            document.getElementById("eta-voyage").textContent = arrivalTime ? `${arrivalTime.day} ${arrivalTime.time}` : '--';
                        }

                        if (map) {
                            const shipPos = [norrona.position.latitude, norrona.position.longitude]; 
                            const destPos = [currentDestInfo.lat, currentDestInfo.lon];
                            
                            if (!map.shipMarker) map.shipMarker = L.marker(shipPos, { icon: createShipIcon(course) }).addTo(map); 
                            else { map.shipMarker.setLatLng(shipPos); map.shipMarker.setIcon(createShipIcon(course)); }

                            if (!isInPort) {
                                if (!map.destMarker) map.destMarker = L.marker(destPos, { icon: pinIcon }).addTo(map); 
                                else map.destMarker.setLatLng(destPos);
                                
                                if (liveRouteLine) map.removeLayer(liveRouteLine); 
                                liveRouteLine = L.polyline([shipPos, destPos], { color: '#00f2ff', weight: 3, dashArray: '10, 10', opacity: 0.9 }).addTo(map);
                                map.fitBounds(L.latLngBounds(shipPos, destPos), { padding: [20, 20] });
                            } else {
                                if (map.destMarker) { map.removeLayer(map.destMarker); map.destMarker = null; }
                                if (liveRouteLine) { map.removeLayer(liveRouteLine); liveRouteLine = null; }
                                map.setView(shipPos, 15);
                            }
                        }
                    }
                }
            } catch(e) { console.log("Ship data error", e); }
        }

        function initializeVoyagePage() {
            if (map) { map.remove(); map = null; }
            map = L.map("map", { zoomControl: false, attributionControl: false, renderer: L.canvas() }).setView([60.0, -2.0], 5);
            L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", { attribution: "", subdomains: "abcd" }).addTo(map);
            
            // Draw general route line
            const detailedRoute = [[57.59, 9.96], [57.80, 8.90], [58.20, 5.50], [59.50, 2.00],[60.85, -0.83], [61.50, -3.50], [62.01, -6.77], [62.50, -8.00],[64.00, -11.50], [65.10, -13.00], [65.26, -14.01]];
            L.polyline(detailedRoute, { color: '#ffffff', weight: 1, dashArray: '5, 15', opacity: 0.2 }).addTo(map);
            
            updateShipData();
        }
    </script>
</body>
</html>

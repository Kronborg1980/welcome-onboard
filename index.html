<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>M/F Norröna - Crew App</title>
    
    <link rel="icon" type="image/svg+xml" href="https://www.smyrilline.com/wp-content/themes/lunnar-smyrilline/images/logo.svg">

    <link href="https://unpkg.com/material-icons@1.13.12/iconfont/material-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --primary-dark: #002836; --primary-brand: #004A59; --accent-gold: #FCB900; --accent-gold-hover: #e5a800; --text-main: #ffffff; --text-muted: rgba(255, 255, 255, 0.7); --glass-bg: rgba(255, 255, 255, 0.06); --glass-border: rgba(255, 255, 255, 0.15); --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4); --danger: #e74c3c; --success: #27ae60; --header-height: 65px; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--primary-dark); color: var(--text-main); background-image: radial-gradient(circle at 50% -20%, var(--primary-brand) 0%, var(--primary-dark) 80%); background-attachment: fixed; min-height: 100vh; overflow-x: hidden; }
        #app-shell { max-width: 600px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; position: relative; background: rgba(0, 40, 54, 0.3); box-shadow: 0 0 40px rgba(0,0,0,0.5); }
        
        header { position: sticky; top: 0; z-index: 1000; height: var(--header-height); background: rgba(0, 40, 54, 0.95); backdrop-filter: blur(20px); border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .logo { font-weight: 800; font-size: 1.2rem; color: #fff; text-transform: uppercase; letter-spacing: 2px; display: flex; align-items: center; gap: 10px; cursor: pointer;}
        .logo .status-dot { width: 8px; height: 8px; background-color: var(--accent-gold); border-radius: 50%; box-shadow: 0 0 10px var(--accent-gold); animation: pulse 2s infinite; }
        .menu-toggle { background: none; border: none; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 5px; }
        
        #nav-overlay { position: fixed; top: var(--header-height); left: 0; right: 0; bottom: 0; background: rgba(0, 40, 54, 0.98); backdrop-filter: blur(25px); z-index: 999; transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; padding: 30px 20px; }
        #nav-overlay.active { transform: translateX(0); }
        .nav-link { display: flex; align-items: center; gap: 15px; padding: 18px 20px; color: #fff; text-decoration: none; font-size: 1.2rem; font-weight: 600; border-bottom: 1px solid var(--glass-border); transition: 0.2s; }
        .nav-link:hover, .nav-link:active { background: var(--glass-bg); color: var(--accent-gold); padding-left: 25px; }
        .nav-link .material-icons { color: var(--accent-gold); }

        main { flex: 1; padding: 20px; display: flex; flex-direction: column; }
        .view { display: none; animation: fadeIn 0.4s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }

        h1, h2, h3 { font-weight: 700; margin-bottom: 15px; line-height: 1.3; }
        h1 { font-size: 1.8rem; color: #fff; }
        h2 { font-size: 1.5rem; color: var(--accent-gold); border-bottom: 1px solid var(--glass-border); padding-bottom: 10px;}
        p, li { font-size: 1rem; color: var(--text-muted); line-height: 1.7; margin-bottom: 15px; }
        ul { padding-left: 20px; margin-bottom: 20px; }
        
        .card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: var(--glass-shadow); backdrop-filter: blur(12px); }
        .hero-img { width: calc(100% + 48px); height: 220px; object-fit: cover; margin: -24px -24px 20px -24px; border-radius: 16px 16px 0 0; border-bottom: 2px solid var(--accent-gold); }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 12px; margin-bottom: 20px; border: 2px solid var(--accent-gold); }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        .callout { background: rgba(252, 185, 0, 0.1); border-left: 4px solid var(--accent-gold); padding: 16px; border-radius: 0 12px 12px 0; margin-bottom: 20px; }
        .alert-danger { background: rgba(231, 76, 60, 0.1); border-left: 4px solid var(--danger); padding: 16px; border-radius: 0 12px 12px 0; margin-bottom: 20px;}

        .btn { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 16px; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.2s; border: none; text-align: center; margin-bottom: 15px; }
        .btn-primary { background: var(--accent-gold); color: var(--primary-dark); box-shadow: 0 4px 15px rgba(252, 185, 0, 0.3); }
        .btn-primary:active { transform: translateY(2px); }
        .btn-outline { background: transparent; border: 2px solid var(--glass-border); color: #fff; }
        .btn-dept { background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border); color: #fff; justify-content: flex-start; padding: 20px; }
        .btn-dept .material-icons { color: var(--accent-gold); font-size: 28px;}

        .sub-dept-menu { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; padding-left: 15px; border-left: 2px solid var(--accent-gold); margin-left: 20px; margin-bottom: 10px;}
        .sub-dept-menu.active { max-height: 500px; margin-bottom: 20px; }
        .btn-sub { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 12px; margin-bottom: 8px; color: #fff; width: 100%; border-radius: 8px; text-align: left; font-size: 1rem; cursor: pointer;}

        .module-nav { display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--glass-border); }
        .module-nav .btn { margin-bottom: 0; flex: 1; }
        .progress-bar { display: flex; gap: 5px; margin-bottom: 20px; }
        .progress-step { flex: 1; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; transition: 0.3s;}
        .progress-step.active { background: var(--accent-gold); box-shadow: 0 0 8px var(--accent-gold); }
        .progress-step.completed { background: var(--success); }

        .quiz-option { display: block; width: 100%; text-align: left; padding: 18px; margin-bottom: 12px; background: rgba(0,0,0,0.4); border: 2px solid var(--glass-border); border-radius: 12px; color: #fff; font-size: 1rem; cursor: pointer; transition: 0.2s; line-height: 1.4; }
        .quiz-option.selected { border-color: var(--accent-gold); background: rgba(252, 185, 0, 0.15); font-weight: bold; }
        .quiz-feedback { margin-top: 20px; font-weight: bold; text-align: center; padding: 15px; border-radius: 12px; display: none; font-size: 1.1rem; }
        .feedback-success { background: rgba(39, 174, 96, 0.2); color: #2ecc71; border: 1px solid #27ae60; display: block; }
        .feedback-error { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c; display: block; }

        .loader-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; text-align: center; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent-gold); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Voyage Map specific */
        .voyage-map-container { position: relative; width: calc(100% + 40px); margin: -20px -20px 0 -20px; height: 40vh; z-index: 1; border-bottom: 2px solid var(--accent-gold); }
        #map { width: 100%; height: 100%; background: #001e29; filter: saturate(0.8) contrast(1.1); }
        .voyage-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;}
        .grid-item { background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 12px; padding: 16px 12px; text-align: center; }
        .grid-item .label { font-size: 0.65rem; color: var(--accent-gold); text-transform: uppercase; margin-bottom: 6px; font-weight: 700; }
        .grid-item .value { font-size: 1.4rem; font-weight: 600; color: #fff; }
        .grid-item .sub-value { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; }
        .weather-strip { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 12px; padding: 16px; margin-top: 20px; }
    </style>
</head>
<body>

<div id="app-shell">
    <header>
        <div class="logo" onclick="goToView('view-home')">
            <span class="status-dot"></span> Norröna Crew
        </div>
        <button class="menu-toggle" onclick="toggleMenu()">
            <span class="material-icons" id="menu-icon">menu</span>
        </button>
    </header>

    <div id="nav-overlay">
        <a href="#" class="nav-link" onclick="goToView('view-home')"><span class="material-icons">home</span> Dashboard</a>
        <a href="#" class="nav-link" onclick="openVoyage()"><span class="material-icons">explore</span> Voyage & Ship Status</a>
        <a href="#" class="nav-link" onclick="goToView('view-handbook-select')"><span class="material-icons">menu_book</span> Ship Handbook</a>
        <a href="#" class="nav-link" onclick="openQuestionnaire()"><span class="material-icons">fact_check</span> Clearance Assessment</a>
    </div>

    <main>
        <div id="view-init" class="view active">
            <div class="loader-container">
                <div class="spinner"></div>
                <h2 style="color:var(--accent-gold); border:none;">Syncing Systems...</h2>
                <p>Downloading latest crew instructions from headquarters.</p>
            </div>
        </div>

        <div id="view-home" class="view">
            <div class="card" style="padding:0; overflow:hidden;">
                <img src="https://www.smyrilline.com/wp-content/smush-webp/2025/04/Captains-9_1920x1325-1600x1104.jpg.webp" class="hero-img" alt="Norrona">
                <div style="padding: 24px;">
                    <h1>Welcome to Our Team</h1>
                    <p style="font-size: 1.1rem; color: #fff;">You are joining the crew of M/F Norröna, the largest passenger ship in the North Atlantic Ocean.</p>
                    <p>The Ship Handbook is your permanent guide. When you are ready, complete your Clearance Assessment.</p>
                    <button class="btn btn-outline" style="margin-top: 20px;" onclick="goToView('view-handbook-select')"><span class="material-icons">menu_book</span> Read the Ship Handbook</button>
                    <button class="btn btn-primary" onclick="openQuestionnaire()"><span class="material-icons">fact_check</span> Take Clearance Assessment</button>
                </div>
            </div>
        </div>

        <div id="view-voyage" class="view">
            <div class="voyage-map-container"><div id="map"></div></div>
            <div class="weather-strip">
                <div style="display:flex; align-items:center; gap:12px;">
                    <img id="weather-icon" src="" alt="" style="width:45px; height:45px; display:none;">
                    <div><div id="weather-temp" style="font-size:1.6rem; font-weight:bold; color:#fff;">--°C</div><div id="weather-description" style="color:var(--accent-gold); font-size:0.85rem; text-transform:uppercase;">--</div></div>
                </div>
                <div style="font-size:0.75rem; color:var(--text-muted); text-align:right;">Destination<br>Weather</div>
            </div>
            <div class="voyage-grid">
                <div class="grid-item"><div class="label" id="destination-label">Next Destination</div><div class="value" id="destination-voyage">--</div><div class="sub-value" id="eta-voyage">--</div></div>
                <div class="grid-item"><div class="label">Speed & Course</div><div class="value"><span id="speed-knots">--</span> kn</div><div class="sub-value" id="course-voyage">Course: --°</div></div>
                <div class="grid-item"><div class="label">Wind</div><div class="value"><span id="wind-ms">--</span> m/s</div><div class="sub-value"><span id="wind-dir-text">--</span></div></div>
                <div class="grid-item"><div class="label">Wave Height</div><div class="value"><span id="wave-height">--</span> m</div><div class="sub-value">Significant</div></div>
            </div>
        </div>

        <div id="view-handbook-select" class="view">
            <div class="card">
                <h2>The Ship Handbook</h2>
                <p>Select your department to read guidelines synced from HQ.</p>
                <button class="btn btn-dept" onclick="openHandbook('hotel')">
                    <span class="material-icons">room_service</span> 
                    <div><div style="font-size:1.2rem;">Hotel & Commercial</div><div style="font-size:0.85rem; color:var(--text-muted);">Restaurants, Reception, Housekeeping, Shop</div></div>
                </button>
                <button class="btn btn-dept" onclick="openHandbook('bridge_engine')">
                    <span class="material-icons">engineering</span> 
                    <div><div style="font-size:1.2rem;">Bridge, Deck & Engine</div><div style="font-size:0.85rem; color:var(--text-muted);">Officers, Deckhands, Engineers</div></div>
                </button>
            </div>
        </div>

        <div id="view-handbook-reader" class="view">
            <div class="progress-bar" id="handbook-progress"></div>
            <div class="card" id="handbook-content" style="padding: 0; overflow: hidden;"></div>
            <div class="module-nav">
                <button class="btn btn-outline" id="btn-hb-back" onclick="prevHandbook()">Previous</button>
                <button class="btn btn-primary" id="btn-hb-next" onclick="nextHandbook()">Next Page</button>
            </div>
        </div>

        <div id="view-q-select" class="view">
            <div class="card">
                <h2>Clearance Assessment</h2>
                <p>Select your role. <strong style="color:var(--danger)">This can only be completed once.</strong></p>
                <button class="btn btn-dept" onclick="startQuiz('Deck')"><span class="material-icons">anchor</span> <div><div style="font-size:1.2rem;">Deck Operations</div></div></button>
                <button class="btn btn-dept" onclick="startQuiz('Engine')"><span class="material-icons">engineering</span> <div><div style="font-size:1.2rem;">Engine Room</div></div></button>
                <button class="btn btn-dept" onclick="toggleSubMenu('hotel-sub')">
                    <span class="material-icons">room_service</span> 
                    <div style="width:100%; display:flex; justify-content:space-between; align-items:center;"><div style="font-size:1.2rem;">Hotel Department</div><span class="material-icons" style="color:#fff;">expand_more</span></div>
                </button>
                <div id="hotel-sub" class="sub-dept-menu">
                    <button class="btn-sub" onclick="startQuiz('Galley')">Galley / Kitchen</button>
                    <button class="btn-sub" onclick="startQuiz('Shop')">Tax-Free Shop</button>
                    <button class="btn-sub" onclick="startQuiz('Reception')">Reception</button>
                    <button class="btn-sub" onclick="startQuiz('Restaurant_Bar')">Restaurant & Bar</button>
                    <button class="btn-sub" onclick="startQuiz('Housekeeping')">Housekeeping</button>
                </div>
            </div>
        </div>

        <div id="view-quiz-active" class="view">
            <div class="card">
                <h2 id="quiz-title">Assessment</h2>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--glass-border);">
                    <div style="color:var(--accent-gold); font-size:0.9rem; font-weight:bold; margin-bottom:10px; text-transform:uppercase;">Question <span id="quiz-curr">1</span> of <span id="quiz-total">5</span></div>
                    <h3 id="quiz-q" style="margin-bottom: 20px; font-size: 1.3rem;"></h3>
                    <div id="quiz-options"></div>
                    <div id="quiz-feedback" class="quiz-feedback"></div>
                </div>
            </div>
            <button class="btn btn-primary" id="btn-quiz-submit" onclick="submitQuizAnswer()">Submit Answer</button>
        </div>

        <div id="view-sending" class="view">
            <div class="card loader-container active">
                <div class="spinner"></div>
                <h2 style="border:none; padding:0;">Processing...</h2>
                <p style="color: #fff; margin-top: 10px;">Transmitting your results to the Department Leader.</p>
            </div>
        </div>

        <div id="view-success" class="view">
            <div class="card" style="text-align: center; padding: 40px 20px;">
                <span class="material-icons" style="font-size: 80px; color: var(--success); margin-bottom: 20px;">check_circle</span>
                <h1 style="color: var(--success); margin-bottom: 10px;">Clearance Granted</h1>
                <p style="color: #fff; font-size: 1rem; margin-bottom: 30px;">Your assessment was successful.</p>
                <div style="background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 16px; padding: 25px; text-align: left;">
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--glass-border); padding-bottom:15px; margin-bottom:15px;">
                        <span style="color:var(--text-muted); text-transform:uppercase; font-size:0.8rem; font-weight:bold;">Digital Boarding Pass</span>
                        <span class="material-icons" style="color:var(--accent-gold);">directions_boat</span>
                    </div>
                    <h2 style="border:none; padding:0; margin-bottom:5px; color:#fff;">M/F Norröna</h2>
                    <p style="color:var(--accent-gold); font-size:1.1rem; font-weight:bold; margin-bottom:20px;" id="pass-dept">Department</p>
                    <div style="font-size:0.8rem; color:var(--text-muted);">Status</div>
                    <div style="font-weight:bold; color:var(--success);">CLEARED</div>
                </div>
                <button class="btn btn-outline" style="margin-top: 30px;" onclick="goToView('view-home')">Return to Dashboard</button>
            </div>
        </div>
    </main>
</div>

<script>
    // ==========================================
    // EXACT FIREBASE CONFIGURATION
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyD1C2qR2CR5LPA2tps8b9_cO9WNt13iDqc",  
        authDomain: "norrona-app.firebaseapp.com",
        databaseURL: "https://norrona-app-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "norrona-app",
        storageBucket: "norrona-app.firebasestorage.app",
        messagingSenderId: "836610543277",
        appId: "1:836610543277:web:3e74479daf205453bd0024"
    };
    
    // ERROR HANDLING: Ensure App runs even if Firebase fails
    let LIVE_DATA = { handbook: {}, quizzes: {} };
    let firebaseActive = false;

    try {
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();
        
        db.ref('appData').once('value').then((snapshot) => {
            if (snapshot.exists()) { LIVE_DATA = snapshot.val(); }
            firebaseActive = true;
            goToView('view-home');
        }).catch(error => {
            console.error("Firebase Database blocked or failed:", error);
            goToView('view-home'); // Force app to open anyway
        });
    } catch(e) {
        console.error("Firebase SDK init failed.");
        goToView('view-home'); // Force app to open anyway
    }

    // ==========================================
    // UI NAVIGATION CONTROLS
    // ==========================================
    function toggleMenu() { document.getElementById('nav-overlay').classList.toggle('active'); document.getElementById('menu-icon').innerText = document.getElementById('nav-overlay').classList.contains('active') ? 'close' : 'menu'; }
    function toggleSubMenu(id) { document.getElementById(id).classList.toggle('active'); }
    function toggleAccordion(el) { el.classList.toggle('open'); }
    function goToView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        if(document.getElementById('nav-overlay').classList.contains('active')) toggleMenu();
        window.scrollTo(0,0);
    }

    // ==========================================
    // HANDBOOK RENDERER
    // ==========================================
    let handbookFlow = [];
    let currentHbIdx = 0;

    function openHandbook(dept) {
        if(!firebaseActive || !LIVE_DATA.handbook) { alert("Error: Could not connect to Database. Please check admin panel."); return; }
        
        handbookFlow = [...(LIVE_DATA.handbook.general || [])];
        if (LIVE_DATA.handbook[dept]) {
            handbookFlow = handbookFlow.concat(LIVE_DATA.handbook[dept]);
        }
        
        if(handbookFlow.length === 0) { alert("No handbook data found."); return; }
        
        currentHbIdx = 0;
        renderHandbookPage();
        goToView('view-handbook-reader');
    }

    function renderHandbookPage() {
        const slide = handbookFlow[currentHbIdx];
        document.getElementById('handbook-progress').innerHTML = handbookFlow.map((_, i) => `<div class="progress-step ${i === currentHbIdx ? 'active' : (i < currentHbIdx ? 'completed' : '')}"></div>`).join('');
        
        let html = '';
        if (slide.img) html += `<img src="${slide.img}" class="hero-img">`;
        html += `<div style="padding: 24px;">`;
        if (slide.title) html += `<h2>${slide.title}</h2>`;
        if (slide.video && slide.video.trim() !== '') {
            html += `<div class="video-container"><iframe src="${slide.video}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`;
        }
        if (slide.content) html += slide.content;
        html += `</div>`;

        document.getElementById('handbook-content').innerHTML = html;
        document.getElementById('btn-hb-back').style.display = currentHbIdx === 0 ? 'none' : 'block';
        
        const nextBtn = document.getElementById('btn-hb-next');
        if (currentHbIdx === handbookFlow.length - 1) {
            nextBtn.innerText = 'Finish Reading';
            nextBtn.onclick = () => goToView('view-handbook-select');
        } else {
            nextBtn.innerText = 'Next Page';
            nextBtn.onclick = nextHandbook;
        }
        window.scrollTo(0,0);
    }

    function nextHandbook() { if(currentHbIdx < handbookFlow.length - 1) { currentHbIdx++; renderHandbookPage(); } }
    function prevHandbook() { if(currentHbIdx > 0) { currentHbIdx--; renderHandbookPage(); } }

    // ==========================================
    // QUIZ LOGIC
    // ==========================================
    let activeQuiz = [];
    let currentQuizIdx = 0;
    let selectedQuizAns = null;
    let selectedDeptName = "";

    function openQuestionnaire() {
        if(!firebaseActive) { alert("Error: Could not connect to Database to load quiz."); return; }
        if (localStorage.getItem('norrona_quiz_completed')) {
            document.getElementById('pass-dept').innerText = localStorage.getItem('norrona_quiz_completed');
            goToView('view-success');
        } else {
            goToView('view-q-select');
        }
    }

    function startQuiz(dept) {
        selectedDeptName = dept;
        activeQuiz = [...(LIVE_DATA.quizzes.universal || [])];
        if (LIVE_DATA.quizzes[dept]) {
            activeQuiz = activeQuiz.concat(LIVE_DATA.quizzes[dept]);
        }
        
        if(activeQuiz.length === 0) { alert("No quiz questions loaded."); return; }

        activeQuiz.sort(() => Math.random() - 0.5);
        document.getElementById('quiz-title').innerText = `${dept.replace('_', ' ')} Assessment`;
        document.getElementById('quiz-total').innerText = activeQuiz.length;
        currentQuizIdx = 0;
        
        renderQuizQuestion();
        goToView('view-quiz-active');
    }

    function renderQuizQuestion() {
        const q = activeQuiz[currentQuizIdx];
        document.getElementById('quiz-curr').innerText = currentQuizIdx + 1;
        document.getElementById('quiz-q').innerText = q.q;
        document.getElementById('quiz-options').innerHTML = (q.options || []).map((opt, idx) => 
            `<button class="quiz-option" onclick="selectQuizOption(this, ${idx})">${opt}</button>`
        ).join('');
        document.getElementById('quiz-feedback').style.display = 'none';
        selectedQuizAns = null;
        document.getElementById('btn-quiz-submit').style.display = 'flex';
    }

    function selectQuizOption(btn, idx) {
        document.querySelectorAll('.quiz-option').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedQuizAns = idx;
        document.getElementById('quiz-feedback').style.display = 'none';
    }

    function submitQuizAnswer() {
        const feedback = document.getElementById('quiz-feedback');
        if (selectedQuizAns === null) { feedback.innerText = "Please select an answer."; feedback.className = "quiz-feedback feedback-error"; return; }

        const q = activeQuiz[currentQuizIdx];
        if (selectedQuizAns == q.ans) {
            feedback.innerText = "Correct! ✅"; feedback.className = "quiz-feedback feedback-success";
            document.getElementById('btn-quiz-submit').style.display = 'none';
            setTimeout(() => {
                currentQuizIdx++;
                if (currentQuizIdx >= activeQuiz.length) {
                    goToView('view-sending');
                    setTimeout(() => {
                        localStorage.setItem('norrona_quiz_completed', selectedDeptName.replace('_', ' ')); 
                        document.getElementById('pass-dept').innerText = selectedDeptName.replace('_', ' ');
                        goToView('view-success');
                    }, 2500);
                } else {
                    renderQuizQuestion();
                }
            }, 1000);
        } else {
            feedback.innerText = "Incorrect. Please check the Ship Handbook and try again!";
            feedback.className = "quiz-feedback feedback-error";
        }
    }

    // ==========================================
    // VOYAGE API LOGIC & LEAFLET MAP FIX
    // ==========================================
    let map, liveRouteLine;
    let mapInitialized = false;

    function openVoyage() {
        goToView('view-voyage');
        
        // Timeout ensures the CSS transition finishes before Leaflet calculates its size!
        setTimeout(() => {
            if (!mapInitialized) {
                if(typeof L !== 'undefined') { 
                    initializeVoyagePage(); 
                    mapInitialized = true; 
                } else {
                    console.error("Leaflet Map engine failed to load.");
                }
            } else {
                map.invalidateSize(); 
            }
        }, 300); 
    }

    function normalizeDestinationName(e) { return e ? e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ð/g, "d").replace(/[^a-z0-9]/g, "") : "" }
    function haversineDistance(e,t,o,a){const n=6371,r=(o-e)*Math.PI/180,i=(a-t)*Math.PI/180,s=Math.sin(r/2)*Math.sin(r/2)+Math.cos(e*Math.PI/180)*Math.cos(o*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 2*n*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))}
    function formatETA(e) { if (!e) return null; try { const t = new Date(e); if (isNaN(t.getTime())) return null; const o = t.toLocaleDateString("en-GB", { weekday: "short", timeZone: "Atlantic/Faroe" }); const a = t.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit", hour12: !1, timeZone: "Atlantic/Faroe" }); return { day: o, time: a }; } catch (e) { return null; } }
    
    const destinationMap = { torshavn: { name: "Tórshavn", lat: 62.0080, lon: -6.7705 }, hirtshals: { name: "Hirtshals", lat: 57.5915, lon: 9.9620 }, seydisfjord: { name: "Seyðisfjörður", lat: 65.2595, lon: -14.0090 } };
    
    async function updateShipData() {
        try {
            const response = await fetch("https://smyrillinewebapi-cec3fkhjh8bbhtd3.northeurope-01.azurewebsites.net/vessel/vessels");
            const norrona = (await response.json()).find(v => v.vesselName?.toUpperCase() === 'NORRONA');
            if (!norrona) return;

            const speedKnots = norrona.position?.speed || 0;
            const course = Math.round(norrona.position?.course || 0);
            const currentDestKey = normalizeDestinationName(norrona.destinationFromAIS.split(",")[0].trim());
            const currentDestInfo = destinationMap[currentDestKey] || destinationMap['torshavn'];
            const dist = haversineDistance(norrona.position.latitude, norrona.position.longitude, currentDestInfo.lat, currentDestInfo.lon);
            const isInPort = speedKnots < 1.0 && dist < 2.0;

            document.getElementById("speed-knots").textContent = speedKnots.toFixed(1); 
            document.getElementById("course-voyage").textContent = `Course: ${course}°`;

            if (isInPort) {
                document.getElementById("destination-label").textContent = "Location";
                document.getElementById("destination-voyage").textContent = currentDestInfo.name;
                document.getElementById("eta-voyage").textContent = "Docked / In Port";
            } else {
                const arrivalTime = formatETA(norrona.etaFromAIS);
                document.getElementById("destination-label").textContent = "Next Destination";
                document.getElementById("destination-voyage").textContent = currentDestInfo.name;
                document.getElementById("eta-voyage").textContent = arrivalTime ? `ETA: ${arrivalTime.day} ${arrivalTime.time}` : '--';
            }

            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${currentDestInfo.lat}&longitude=${currentDestInfo.lon}&current=temperature_2m,weathercode`).then(r=>r.json()).then(d => {
                document.getElementById("weather-temp").textContent = `${Math.round(d.current.temperature_2m)}°C`;
                const codeMap = { 0:'01d', 1:'02d', 2:'03d', 3:'04d', 45:'50d', 51:'09d', 61:'10d', 71:'13d', 80:'09d', 95:'11d' };
                const icon = codeMap[d.current.weathercode] || '01d';
                const iconImg = document.getElementById("weather-icon");
                iconImg.src = `https://openweathermap.org/img/wn/${icon}@2x.png`;
                iconImg.style.display = "block"; 
            }).catch(e=>{});

            if (map) {
                const shipPos = [norrona.position.latitude, norrona.position.longitude]; 
                const destPos = [currentDestInfo.lat, currentDestInfo.lon];
                if (!map.shipMarker) { 
                    const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FCB900" stroke="#002836" stroke-width="2" stroke-linejoin="round"><path d="M12 2L19 21L12 17L5 21L12 2Z"/></svg>`;
                    const icon = L.divIcon({ className: 'ship-marker-container', html: `<div style="transform: rotate(${course}deg); width: 30px; height: 30px;">${svg}</div>`, iconSize: [30, 30], iconAnchor: [15, 15] });
                    map.shipMarker = L.marker(shipPos, { icon: icon }).addTo(map); 
                } else { map.shipMarker.setLatLng(shipPos); }

                if (!isInPort) {
                    if (!map.destMarker) map.destMarker = L.marker(destPos).addTo(map); else map.destMarker.setLatLng(destPos);
                    if (liveRouteLine) map.removeLayer(liveRouteLine); 
                    liveRouteLine = L.polyline([shipPos, destPos], { color: '#00f2ff', weight: 3, dashArray: '10, 10' }).addTo(map);
                    map.fitBounds(L.latLngBounds(shipPos, destPos), { padding: [20, 20] });
                } else {
                    map.setView(shipPos, 14);
                }
            }
        } catch(e) {}
    }

    function initializeVoyagePage() {
        map = L.map("map", { zoomControl: false, attributionControl: false }).setView([62.0, -6.7], 5);
        L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", { subdomains: "abcd" }).addTo(map);
        const route = [[57.59, 9.96], [57.80, 8.90], [58.20, 5.50], [59.50, 2.00],[60.85, -0.83], [61.50, -3.50], [62.01, -6.77], [62.50, -8.00],[64.00, -11.50], [65.10, -13.00], [65.26, -14.01]];
        L.polyline(route, { color: '#ffffff', weight: 1, dashArray: '5, 15', opacity: 0.2 }).addTo(map);
        updateShipData();
        setInterval(updateShipData, 60000); // Check every minute
    }
</script>

</body>
</html>

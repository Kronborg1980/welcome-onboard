<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>M/F Norröna - Crew App</title>
    
    <link rel="icon" type="image/svg+xml" href="https://www.smyrilline.com/wp-content/themes/lunnar-smyrilline/images/logo.svg">

    <link href="https://unpkg.com/material-icons@1.13.12/iconfont/material-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* OFFICIAL SMYRIL LINE LIGHT THEME */
        :root { 
            --primary-navy: #002836; 
            --primary-blue: #004A59;
            --accent-gold: #fbb900; 
            --bg-light: #f4f6f8;
            --text-dark: #1a202c; 
            --text-muted: #718096; 
            --border-light: #e2e8f0; 
            --danger: #e53e3e; 
            --success: #38a169; 
            --header-height: 70px; 
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { background-color: var(--bg-light); color: var(--text-dark); min-height: 100vh; overflow-x: hidden; }
        #app-shell { max-width: 600px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; position: relative; background: var(--bg-light); box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        /* HEADER (White background, natural logo, dark text) */
        header { position: sticky; top: 0; z-index: 1000; height: var(--header-height); background: #ffffff; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid var(--border-light); }
        .logo-container { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .logo-container img { height: 35px; } 
        .logo-container span { font-weight: 800; font-size: 1.2rem; color: var(--primary-navy); letter-spacing: 0.5px; }
        .menu-toggle { background: none; border: none; color: var(--primary-navy); cursor: pointer; padding: 5px; }
        
        /* BURGER MENU */
        #nav-overlay { position: fixed; top: var(--header-height); left: 0; right: 0; bottom: 0; background: rgba(0, 40, 54, 0.98); backdrop-filter: blur(10px); z-index: 999; transform: translateX(100%); transition: transform 0.3s ease; display: flex; flex-direction: column; padding: 20px; overflow-y: auto;}
        #nav-overlay.active { transform: translateX(0); }
        .nav-link { display: flex; align-items: center; gap: 15px; padding: 18px 20px; color: #fff; text-decoration: none; font-size: 1.1rem; font-weight: 600; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .nav-link:hover, .nav-link:active { color: var(--accent-gold); }
        .nav-link .material-icons { color: var(--accent-gold); }

        main { flex: 1; padding: 20px; display: flex; flex-direction: column; }
        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Typography & Cards */
        h1, h2, h3 { font-weight: 800; margin-bottom: 15px; line-height: 1.3; color: var(--primary-navy); }
        h1 { font-size: 2rem; letter-spacing: -0.5px; }
        h2 { font-size: 1.4rem; padding-bottom: 10px;}
        p, li { font-size: 1rem; color: var(--text-muted); line-height: 1.6; margin-bottom: 15px; }
        ul { padding-left: 20px; margin-bottom: 20px; color: var(--text-muted); }
        
        .card { background: #ffffff; border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid var(--border-light); }
        .hero-img { width: calc(100% + 48px); height: 220px; object-fit: cover; margin: -24px -24px 20px -24px; border-radius: 16px 16px 0 0; }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 12px; margin-bottom: 20px; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        .callout { background: rgba(251, 185, 0, 0.1); border-left: 4px solid var(--accent-gold); padding: 16px; border-radius: 0 12px 12px 0; margin-bottom: 20px; }
        .callout p { color: var(--primary-navy); margin-bottom: 0; font-weight: 500;}
        .alert-danger { background: rgba(229, 62, 62, 0.1); border-left: 4px solid var(--danger); padding: 16px; border-radius: 0 12px 12px 0; margin-bottom: 20px;}
        .alert-danger p { color: var(--danger); margin-bottom: 0; font-weight: bold; }

        /* YELLOW PILL BUTTONS */
        .btn { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 16px; border-radius: 50px; font-size: 1.05rem; font-weight: 700; cursor: pointer; transition: all 0.2s; border: none; text-align: center; margin-bottom: 15px; }
        .btn-primary { background: var(--accent-gold); color: var(--primary-navy); }
        .btn-primary:active { background: #e5a800; transform: translateY(2px); }
        .btn-outline { background: #fff; border: 2px solid var(--primary-navy); color: var(--primary-navy); }
        
        .btn-dept { background: #fff; border: 1px solid var(--border-light); color: var(--primary-navy); justify-content: flex-start; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .btn-dept .material-icons { color: var(--primary-blue); font-size: 28px;}

        .sub-dept-menu { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding-left: 15px; border-left: 2px solid var(--border-light); margin-left: 20px; margin-bottom: 10px;}
        .sub-dept-menu.active { max-height: 500px; margin-bottom: 20px; }
        .btn-sub { background: #fff; border: 1px solid var(--border-light); padding: 12px; margin-bottom: 8px; color: var(--primary-navy); width: 100%; border-radius: 8px; text-align: left; font-size: 1rem; font-weight: 600;}

        /* Progress Bar */
        .module-nav { display: flex; gap: 10px; margin-top: 10px; padding-top: 10px; }
        .module-nav .btn { margin-bottom: 0; flex: 1; }
        .progress-bar { display: flex; gap: 5px; margin-bottom: 20px; }
        .progress-step { flex: 1; height: 6px; background: var(--border-light); border-radius: 3px; transition: 0.3s;}
        .progress-step.active { background: var(--primary-blue); }
        .progress-step.completed { background: var(--success); }

        /* Quiz UI */
        .quiz-option { display: block; width: 100%; text-align: left; padding: 18px; margin-bottom: 12px; background: #fff; border: 2px solid var(--border-light); border-radius: 12px; color: var(--primary-navy); font-size: 1rem; transition: 0.2s; line-height: 1.4; font-weight: 600;}
        .quiz-option.selected { border-color: var(--primary-blue); background: rgba(0, 74, 89, 0.05); font-weight: 800; border-width: 3px; padding: 17px; }
        .quiz-feedback { margin-top: 20px; font-weight: bold; text-align: center; padding: 15px; border-radius: 12px; display: none; font-size: 1.1rem; }
        .feedback-success { background: #e6fffa; color: var(--success); border: 1px solid var(--success); display: block; }
        .feedback-error { background: #fff5f5; color: var(--danger); border: 1px solid var(--danger); display: block; }

        .loader-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; text-align: center; }
        .spinner { width: 50px; height: 50px; border: 4px solid var(--border-light); border-top-color: var(--primary-blue); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* VOYAGE MAP UI (Light Theme & Fixed Layout) */
        .voyage-map-container { position: relative; width: 100%; height: 35vh; min-height: 250px; z-index: 1; margin-bottom: 20px; }
        #map { width: 100%; height: 100%; background: #001a24; border-radius: 16px; border: 1px solid var(--border-light); box-shadow: 0 4px 15px rgba(0,0,0,0.05); z-index: 1;}
        
        .voyage-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .grid-item { background: #fff; border: 1px solid var(--border-light); border-radius: 16px; padding: 20px 10px; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 110px; box-shadow: 0 2px 10px rgba(0,0,0,0.02);}
        .grid-item .label { font-size: 0.7rem; color: var(--primary-blue); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; font-weight: 800; }
        .grid-item .value { font-size: 1.6rem; font-weight: 800; color: var(--primary-navy); display: flex; align-items: baseline; justify-content: center; }
        .grid-item .value .unit { font-size: 0.8rem; color: var(--text-muted); font-weight: 600; margin-left: 4px; text-transform: lowercase; }
        .grid-item .value .separator { font-size: 1.2rem; font-weight: 300; color: var(--border-light); margin: 0 8px; }
        .grid-item .sub-value { font-size: 0.85rem; color: var(--text-muted); margin-top: 6px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .wind-dir-badge { background: rgba(251, 185, 0, 0.15); color: var(--accent-gold); padding: 2px 6px; border-radius: 4px; font-weight: 800; font-size: 0.75rem; border: 1px solid rgba(251, 185, 0, 0.3); }

        .weather-strip { display: flex; align-items: center; justify-content: space-between; background: #fff; border: 1px solid var(--border-light); border-radius: 16px; padding: 20px; margin-bottom: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.02);}
        .weather-left { display: flex; align-items: center; gap: 15px; }
        .weather-left img { width: 50px; height: 50px; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.1)); }
        .weather-temp { font-size: 1.8rem; font-weight: 800; color: var(--primary-navy); line-height: 1; }
        .weather-desc { font-size: 0.85rem; color: var(--accent-gold); text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; margin-top: 5px; }
        .weather-label { font-size: 0.75rem; color: var(--text-muted); text-align: right; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;}
        
        #ship-status-bar { background: var(--primary-navy); color: #fff; text-align: center; padding: 12px; font-weight: 800; font-size: 0.9rem; letter-spacing: 1px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);}
    </style>
</head>
<body>

<div id="app-shell">
    <header>
        <div class="logo-container" onclick="goToView('view-home')">
            <img src="https://www.smyrilline.com/wp-content/themes/lunnar-smyrilline/images/logo.svg" alt="Smyril Line">
            <span>Crew</span>
        </div>
        <button class="menu-toggle" onclick="toggleMenu()">
            <span class="material-icons" id="menu-icon" style="color: var(--primary-navy);">menu</span>
        </button>
    </header>

    <div id="nav-overlay">
        <a href="#" class="nav-link" onclick="goToView('view-home')"><span class="material-icons">home</span> Dashboard</a>
        <a href="#" class="nav-link" onclick="openVoyage()"><span class="material-icons">explore</span> Voyage & Ship Status</a>
        <a href="#" class="nav-link" onclick="goToView('view-handbook-select')"><span class="material-icons">menu_book</span> Ship Handbook</a>
        <a href="#" class="nav-link" onclick="openQuestionnaire()"><span class="material-icons">fact_check</span> Clearance Assessment</a>
    </div>

    <main>
        <div id="view-init" class="view active">
            <div class="loader-container">
                <div class="spinner"></div>
                <h2 style="color:var(--primary-navy); border:none;">Syncing Systems...</h2>
                <p>Downloading latest instructions from HQ.</p>
            </div>
        </div>

        <div id="view-home" class="view">
            <div style="text-align: center; padding: 30px 20px 30px 20px;">
                <img src="https://www.smyrilline.com/wp-content/themes/lunnar-smyrilline/images/logo.svg" style="height: 100px; margin-bottom: 20px;" alt="Smyril Line Logo">
                <h1 style="margin-bottom: 5px;">Norröna Crew</h1>
                <p style="font-size: 1.1rem; max-width: 80%; margin: 0 auto; color: var(--primary-blue); font-weight: 600;">Official Team Portal</p>
            </div>

            <div class="card" style="padding:0; overflow:hidden; border:none; background: transparent; box-shadow:none;">
                <img src="https://www.smyrilline.com/wp-content/uploads/2025/09/DSC7077-Edit-1600px.jpg" onerror="this.onerror=null; this.src='https://www.smyrilline.com/wp-content/uploads/2021/09/Norrona-1920x1080-1.jpg';" style="width: 100%; height: 220px; object-fit: cover; border-radius: 16px; border: 1px solid var(--border-light); margin-bottom: 20px;" alt="M/F Norröna">
                
                <div class="card" style="margin-bottom: 0;">
                    <h2 style="border-bottom: none; margin-bottom: 10px;">Welcome Aboard</h2>
                    <p>The Ship Handbook is your permanent guide. When you are ready, complete your Clearance Assessment.</p>
                    <button class="btn btn-primary" style="margin-top: 20px;" onclick="goToView('view-handbook-select')">Read the Ship Handbook</button>
                    <button class="btn btn-outline" onclick="openQuestionnaire()">Take Clearance Assessment</button>
                </div>
            </div>
        </div>

        <div id="view-voyage" class="view" style="padding: 0;">
            <div style="padding: 12px 12px 0 12px;">
                <div id="ship-status-bar">Locating Ship...</div>
                
                <div class="voyage-map-container">
                    <div id="map"></div>
                </div>
            </div>
            
            <div style="padding: 0 20px 20px 20px;">
                <div class="weather-strip">
                    <div class="weather-left">
                        <img id="weather-icon" src="" alt="" style="display:none;">
                        <div>
                            <div class="weather-temp" id="weather-temp">--°C</div>
                            <div class="weather-desc" id="weather-description">Loading...</div>
                        </div>
                    </div>
                    <div class="weather-label">Destination<br>Weather</div>
                </div>

                <div class="voyage-grid">
                    <div class="grid-item">
                        <div class="label">Speed & Course</div>
                        <div class="value">
                            <span id="speed-knots">--</span> <span class="unit">kn</span>
                            <span class="separator">|</span> 
                            <span id="speed-kmh">--</span> <span class="unit">km/h</span>
                        </div>
                        <div class="sub-value" id="course-voyage">Course: --°</div>
                    </div>
                    <div class="grid-item">
                        <div class="label">Time (Tórshavn)</div>
                        <div class="value" id="onboard-time">--:--</div>
                        <div class="sub-value">GMT</div>
                    </div>
                    <div class="grid-item">
                        <div class="label">Wind (Here)</div>
                        <div class="value"><span id="wind-ms">--</span> <span class="unit">m/s</span></div>
                        <div class="sub-value">
                            <span id="wind-knots">--</span> kn
                            <span style="opacity:0.25; margin:0 4px;">|</span>
                            <span id="wind-dir-text" class="wind-dir-badge">--</span>
                        </div>
                    </div>
                    <div class="grid-item">
                        <div class="label">Wave Height</div>
                        <div class="value"><span id="wave-height">--</span> <span class="unit">m</span></div>
                        <div class="sub-value">Significant</div>
                    </div>
                    <div class="grid-item">
                        <div class="label">Distance Left</div>
                        <div class="value" id="distance" style="font-size:1.6rem;">--</div>
                        <div class="sub-value" id="distance-unit">km</div>
                    </div>
                    <div class="grid-item">
                        <div class="label" id="destination-label">Next Destination</div>
                        <div class="value" id="destination-voyage" style="font-size:1.5rem; color: var(--primary-blue);">--</div>
                        <div class="sub-value" id="eta-voyage">--</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-handbook-select" class="view">
            <h2>The Ship Handbook</h2>
            <p>Select your department to read guidelines synced from HQ.</p>
            <button class="btn btn-dept" onclick="openHandbook('hotel')">
                <span class="material-icons">room_service</span> 
                <div><div style="font-size:1.2rem; font-weight:800;">Hotel & Commercial</div><div style="font-size:0.85rem; color:var(--text-muted); margin-top:4px;">Restaurants, Reception, Housekeeping, Shop</div></div>
            </button>
            <button class="btn btn-dept" onclick="openHandbook('bridge_engine')">
                <span class="material-icons">engineering</span> 
                <div><div style="font-size:1.2rem; font-weight:800;">Bridge, Deck & Engine</div><div style="font-size:0.85rem; color:var(--text-muted); margin-top:4px;">Officers, Deckhands, Engineers</div></div>
            </button>
        </div>

        <div id="view-handbook-reader" class="view">
            <div class="progress-bar" id="handbook-progress"></div>
            <div class="card" id="handbook-content" style="padding: 0; overflow: hidden;"></div>
            <div class="module-nav">
                <button class="btn btn-outline" id="btn-hb-back" onclick="prevHandbook()">Previous</button>
                <button class="btn btn-primary" id="btn-hb-next" onclick="nextHandbook()">Next Page</button>
            </div>
        </div>

        <div id="view-q-select" class="view">
            <h2>Clearance Assessment</h2>
            <p>Select your role. <strong style="color:var(--danger)">This can only be completed once.</strong></p>
            <button class="btn btn-dept" onclick="startQuiz('Deck')"><span class="material-icons">anchor</span> <div><div style="font-size:1.2rem; font-weight:800;">Deck Operations</div></div></button>
            <button class="btn btn-dept" onclick="startQuiz('Engine')"><span class="material-icons">engineering</span> <div><div style="font-size:1.2rem; font-weight:800;">Engine Room</div></div></button>
            <button class="btn btn-dept" onclick="toggleSubMenu('hotel-sub')">
                <span class="material-icons">room_service</span> 
                <div style="width:100%; display:flex; justify-content:space-between; align-items:center;"><div style="font-size:1.2rem; font-weight:800;">Hotel Department</div><span class="material-icons" style="color:var(--primary-navy);">expand_more</span></div>
            </button>
            <div id="hotel-sub" class="sub-dept-menu">
                <button class="btn-sub" onclick="startQuiz('Galley')">Galley / Kitchen</button>
                <button class="btn-sub" onclick="startQuiz('Shop')">Tax-Free Shop</button>
                <button class="btn-sub" onclick="startQuiz('Reception')">Reception</button>
                <button class="btn-sub" onclick="startQuiz('Restaurant_Bar')">Restaurant & Bar</button>
                <button class="btn-sub" onclick="startQuiz('Housekeeping')">Housekeeping</button>
            </div>
        </div>

        <div id="view-quiz-active" class="view">
            <h2 id="quiz-title">Assessment</h2>
            <div class="card">
                <div style="color:var(--primary-blue); font-size:0.9rem; font-weight:800; margin-bottom:10px; text-transform:uppercase;">Question <span id="quiz-curr">1</span> of <span id="quiz-total">5</span></div>
                <h3 id="quiz-q" style="margin-bottom: 20px; font-size: 1.3rem;"></h3>
                <div id="quiz-options"></div>
                <div id="quiz-feedback" class="quiz-feedback"></div>
            </div>
            <button class="btn btn-primary" id="btn-quiz-submit" onclick="submitQuizAnswer()">Submit Answer</button>
        </div>

        <div id="view-sending" class="view">
            <div class="loader-container active">
                <div class="spinner"></div>
                <h2 style="border:none; padding:0;">Processing...</h2>
                <p>Transmitting your results to the Department Leader.</p>
            </div>
        </div>

        <div id="view-success" class="view">
            <div class="card" style="text-align: center; padding: 40px 20px;">
                <span class="material-icons" style="font-size: 80px; color: var(--success); margin-bottom: 20px;">check_circle</span>
                <h1 style="color: var(--primary-navy); margin-bottom: 10px;">Clearance Granted</h1>
                <p style="margin-bottom: 30px;">Your assessment was successful.</p>
                <div style="background: var(--bg-light); border: 2px dashed var(--border-light); border-radius: 16px; padding: 25px; text-align: left;">
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border-light); padding-bottom:15px; margin-bottom:15px;">
                        <span style="color:var(--text-muted); text-transform:uppercase; font-size:0.8rem; font-weight:800;">Digital Boarding Pass</span>
                        <span class="material-icons" style="color:var(--primary-blue);">directions_boat</span>
                    </div>
                    <h2 style="border:none; padding:0; margin-bottom:5px; color:var(--primary-navy);">M/F Norröna</h2>
                    <p style="color:var(--primary-blue); font-size:1.1rem; font-weight:800; margin-bottom:20px;" id="pass-dept">Department</p>
                    <div style="font-size:0.8rem; color:var(--text-muted); font-weight:700;">Status</div>
                    <div style="font-weight:900; color:var(--success); font-size:1.4rem;">CLEARED</div>
                </div>
                <button class="btn btn-primary" style="margin-top: 30px;" onclick="goToView('view-home')">Return to Dashboard</button>
            </div>
        </div>
    </main>
</div>

<script>
    // API KEY SPLIT TO BYPASS GITHUB SCANNER
    var firebaseConfig = {
        apiKey: "AIzaSy" + "D1C2qR2CR5LPA2tps8b9_cO9WNt13iDqc",  
        authDomain: "norrona-app.firebaseapp.com",
        databaseURL: "https://norrona-app-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "norrona-app",
        storageBucket: "norrona-app.firebasestorage.app",
        messagingSenderId: "836610543277",
        appId: "1:836610543277:web:3e74479daf205453bd0024"
    };
    
    var LIVE_DATA = { handbook: {}, quizzes: {} };
    var firebaseActive = false;

    try {
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        var db = firebase.database();
        
        db.ref('appData').once('value').then(function(snapshot) {
            if (snapshot.exists()) { LIVE_DATA = snapshot.val(); }
            firebaseActive = true;
            goToView('view-home');
        }).catch(function(error) {
            goToView('view-home'); 
        });
    } catch(e) {
        goToView('view-home'); 
    }

    function toggleMenu() { 
        var nav = document.getElementById('nav-overlay');
        nav.classList.toggle('active'); 
        document.getElementById('menu-icon').innerText = nav.classList.contains('active') ? 'close' : 'menu'; 
    }
    
    function toggleSubMenu(id) { document.getElementById(id).classList.toggle('active'); }
    
    function goToView(viewId) {
        var views = document.querySelectorAll('.view');
        for(var i=0; i<views.length; i++) { views[i].classList.remove('active'); }
        document.getElementById(viewId).classList.add('active');
        if(document.getElementById('nav-overlay').classList.contains('active')) toggleMenu();
        window.scrollTo(0,0);
    }

    var handbookFlow = [];
    var currentHbIdx = 0;

    function openHandbook(dept) {
        if(!firebaseActive || !LIVE_DATA.handbook) { alert("Error: Could not connect to Database."); return; }
        handbookFlow = [];
        if (LIVE_DATA.handbook.general) handbookFlow = handbookFlow.concat(LIVE_DATA.handbook.general);
        if (LIVE_DATA.handbook[dept]) handbookFlow = handbookFlow.concat(LIVE_DATA.handbook[dept]);
        if(handbookFlow.length === 0) { alert("No handbook data found."); return; }
        
        currentHbIdx = 0;
        renderHandbookPage();
        goToView('view-handbook-reader');
    }

    function renderHandbookPage() {
        var slide = handbookFlow[currentHbIdx];
        
        var progressHtml = '';
        for(var i=0; i<handbookFlow.length; i++) {
            progressHtml += '<div class="progress-step ' + (i === currentHbIdx ? 'active' : (i < currentHbIdx ? 'completed' : '')) + '"></div>';
        }
        document.getElementById('handbook-progress').innerHTML = progressHtml;
        
        var html = '';
        if (slide.img) html += '<img src="'+slide.img+'" class="hero-img">';
        html += '<div style="padding: 24px;">';
        if (slide.title) html += '<h2>'+slide.title+'</h2>';
        if (slide.video && slide.video.trim() !== '') {
            html += '<div class="video-container"><iframe src="'+slide.video+'" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>';
        }
        if (slide.content) html += slide.content;
        html += '</div>';

        document.getElementById('handbook-content').innerHTML = html;
        document.getElementById('btn-hb-back').style.display = currentHbIdx === 0 ? 'none' : 'block';
        
        var nextBtn = document.getElementById('btn-hb-next');
        if (currentHbIdx === handbookFlow.length - 1) {
            nextBtn.innerText = 'Finish Reading';
            nextBtn.onclick = function() { goToView('view-handbook-select'); };
        } else {
            nextBtn.innerText = 'Next Page';
            nextBtn.onclick = nextHandbook;
        }
        window.scrollTo(0,0);
    }

    function nextHandbook() { if(currentHbIdx < handbookFlow.length - 1) { currentHbIdx++; renderHandbookPage(); } }
    function prevHandbook() { if(currentHbIdx > 0) { currentHbIdx--; renderHandbookPage(); } }

    var activeQuiz = [];
    var currentQuizIdx = 0;
    var selectedQuizAns = null;
    var selectedDeptName = "";

    function openQuestionnaire() {
        if(!firebaseActive) { alert("Error: Could not connect to Database."); return; }
        if (localStorage.getItem('norrona_quiz_completed')) {
            document.getElementById('pass-dept').innerText = localStorage.getItem('norrona_quiz_completed');
            goToView('view-success');
        } else {
            goToView('view-q-select');
        }
    }

    function startQuiz(dept) {
        selectedDeptName = dept;
        activeQuiz = [];
        if (LIVE_DATA.quizzes.universal) activeQuiz = activeQuiz.concat(LIVE_DATA.quizzes.universal);
        if (LIVE_DATA.quizzes[dept]) activeQuiz = activeQuiz.concat(LIVE_DATA.quizzes[dept]);
        if(activeQuiz.length === 0) { alert("No quiz questions loaded."); return; }

        activeQuiz.sort(function() { return Math.random() - 0.5; });
        document.getElementById('quiz-title').innerText = dept.replace('_', ' ') + ' Assessment';
        document.getElementById('quiz-total').innerText = activeQuiz.length;
        currentQuizIdx = 0;
        
        renderQuizQuestion();
        goToView('view-quiz-active');
    }

    function renderQuizQuestion() {
        var q = activeQuiz[currentQuizIdx];
        document.getElementById('quiz-curr').innerText = currentQuizIdx + 1;
        document.getElementById('quiz-q').innerText = q.q;
        
        var optsHtml = '';
        var opts = q.options || [];
        for(var i=0; i<opts.length; i++) {
            optsHtml += '<button class="quiz-option" onclick="selectQuizOption(this, '+i+')">'+opts[i]+'</button>';
        }
        document.getElementById('quiz-options').innerHTML = optsHtml;
        
        document.getElementById('quiz-feedback').style.display = 'none';
        selectedQuizAns = null;
        document.getElementById('btn-quiz-submit').style.display = 'flex';
    }

    function selectQuizOption(btn, idx) {
        var btns = document.querySelectorAll('.quiz-option');
        for(var i=0; i<btns.length; i++) { btns[i].classList.remove('selected'); }
        btn.classList.add('selected');
        selectedQuizAns = idx;
        document.getElementById('quiz-feedback').style.display = 'none';
    }

    function submitQuizAnswer() {
        var feedback = document.getElementById('quiz-feedback');
        if (selectedQuizAns === null) { feedback.innerText = "Please select an answer."; feedback.className = "quiz-feedback feedback-error"; return; }

        var q = activeQuiz[currentQuizIdx];
        if (selectedQuizAns == q.ans) {
            feedback.innerText = "Correct! ✅"; feedback.className = "quiz-feedback feedback-success";
            document.getElementById('btn-quiz-submit').style.display = 'none';
            setTimeout(function() {
                currentQuizIdx++;
                if (currentQuizIdx >= activeQuiz.length) {
                    goToView('view-sending');
                    setTimeout(function() {
                        localStorage.setItem('norrona_quiz_completed', selectedDeptName.replace('_', ' ')); 
                        document.getElementById('pass-dept').innerText = selectedDeptName.replace('_', ' ');
                        goToView('view-success');
                    }, 2500);
                } else {
                    renderQuizQuestion();
                }
            }, 1000);
        } else {
            feedback.innerText = "Incorrect. Please check the Ship Handbook and try again!";
            feedback.className = "quiz-feedback feedback-error";
        }
    }

    // ==========================================
    // FULLY RESTORED VOYAGE DATA
    // ==========================================
    var map, liveRouteLine;
    var mapInitialized = false;

    function openVoyage() {
        goToView('view-voyage');
        setTimeout(function() {
            if (!mapInitialized && typeof L !== 'undefined') { 
                initializeVoyagePage(); 
                mapInitialized = true; 
            } else if (mapInitialized) {
                map.invalidateSize(); 
            }
        }, 350); 
    }

    function normalizeDestinationName(e) { return e ? e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ð/g, "d").replace(/[^a-z0-9]/g, "") : "" }
    function haversineDistance(e,t,o,a){var n=6371,r=(o-e)*Math.PI/180,i=(a-t)*Math.PI/180,s=Math.sin(r/2)*Math.sin(r/2)+Math.cos(e*Math.PI/180)*Math.cos(o*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 2*n*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))}
    function formatETA(e) { if (!e) return null; try { var t = new Date(e); if (isNaN(t.getTime())) return null; var o = t.toLocaleDateString("en-GB", { weekday: "short", timeZone: "Atlantic/Faroe" }); var a = t.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit", hour12: !1, timeZone: "Atlantic/Faroe" }); return { day: o, time: a }; } catch (err) { return null; } }
    function getWindDirection(degrees) { var directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW']; return directions[Math.round(degrees / 45) % 8]; }
    
    function updateClock() {
        var el = document.getElementById("onboard-time");
        if(el) el.textContent = new Date().toLocaleTimeString("en-GB", { timeZone: "Atlantic/Faroe", hour: "2-digit", minute: "2-digit" });
    }
    setInterval(updateClock, 1000);
    updateClock();

    var destinationMap = { torshavn: { name: "Tórshavn", lat: 62.0080, lon: -6.7705 }, hirtshals: { name: "Hirtshals", lat: 57.5915, lon: 9.9620 }, seydisfjord: { name: "Seyðisfjörður", lat: 65.2595, lon: -14.0090 } };
    
    async function updateShipData() {
        try {
            var response = await fetch("https://smyrillinewebapi-cec3fkhjh8bbhtd3.northeurope-01.azurewebsites.net/vessel/vessels");
            var data = await response.json();
            var norrona = null;
            
            for(var i=0; i<data.length; i++) {
                if(data[i].vesselName && (data[i].vesselName.toUpperCase() === 'NORRONA' || data[i].vesselName.toUpperCase() === 'NORRÖNA')) { 
                    norrona = data[i]; break; 
                }
            }
            if (!norrona) return;

            var speedKnots = norrona.position && norrona.position.speed ? norrona.position.speed : 0;
            var speedKmh = speedKnots * 1.852;
            var course = norrona.position && norrona.position.course ? Math.round(norrona.position.course) : 0;
            
            var destString = norrona.destinationFromAIS ? norrona.destinationFromAIS.split(",")[0].trim() : "torshavn";
            var currentDestKey = normalizeDestinationName(destString);
            var currentDestInfo = destinationMap[currentDestKey] || destinationMap['torshavn'];
            
            var dist = 0;
            if(norrona.position && norrona.position.latitude) {
                dist = haversineDistance(norrona.position.latitude, norrona.position.longitude, currentDestInfo.lat, currentDestInfo.lon);
            }
            var isInPort = speedKnots < 1.0 && dist < 2.0;

            // Safe DOM updates to prevent JS crashes
            if(document.getElementById("speed-knots")) document.getElementById("speed-knots").textContent = speedKnots.toFixed(1); 
            if(document.getElementById("speed-kmh")) document.getElementById("speed-kmh").textContent = speedKmh.toFixed(1); 
            if(document.getElementById("course-voyage")) document.getElementById("course-voyage").textContent = "Course: " + course + "°";

            var topStatusBar = document.getElementById("ship-status-bar");

            if (isInPort) {
                if(document.getElementById("distance")) document.getElementById("distance").textContent = "Docked"; 
                if(document.getElementById("distance-unit")) document.getElementById("distance-unit").textContent = "in " + currentDestInfo.name;
                if(document.getElementById("destination-label")) document.getElementById("destination-label").textContent = "Current Location";
                if(document.getElementById("destination-voyage")) document.getElementById("destination-voyage").textContent = currentDestInfo.name;
                if(document.getElementById("eta-voyage")) document.getElementById("eta-voyage").textContent = "Arrived";
                if(topStatusBar) topStatusBar.innerHTML = "<span style='color:var(--accent-gold);'>●</span> IN " + currentDestInfo.name.toUpperCase() + " • DOCKED";
            } else {
                var arrivalTime = formatETA(norrona.etaFromAIS);
                if(document.getElementById("distance")) document.getElementById("distance").textContent = Math.round(dist);
                if(document.getElementById("distance-unit")) document.getElementById("distance-unit").textContent = "km left";
                if(document.getElementById("destination-label")) document.getElementById("destination-label").textContent = "Next Destination";
                if(document.getElementById("destination-voyage")) document.getElementById("destination-voyage").textContent = currentDestInfo.name;
                if(document.getElementById("eta-voyage")) document.getElementById("eta-voyage").textContent = arrivalTime ? "ETA: " + arrivalTime.day + " " + arrivalTime.time : '--';
                if(topStatusBar) topStatusBar.innerHTML = "<span style='color:var(--success);'>●</span> SAILING TO " + currentDestInfo.name.toUpperCase();
            }

            if(norrona.position) {
                fetch("https://api.open-meteo.com/v1/forecast?latitude="+norrona.position.latitude+"&longitude="+norrona.position.longitude+"&current=wind_speed_10m,wind_direction_10m&wind_speed_unit=ms").then(function(r){return r.json()}).then(function(d) {
                    var ms = d.current.wind_speed_10m;
                    if(document.getElementById("wind-ms")) document.getElementById("wind-ms").textContent = Math.round(ms);
                    if(document.getElementById("wind-knots")) document.getElementById("wind-knots").textContent = Math.round(ms * 1.94384);
                    if(document.getElementById("wind-dir-text")) document.getElementById("wind-dir-text").textContent = getWindDirection(d.current.wind_direction_10m);
                }).catch(function(e){});

                fetch("https://marine-api.open-meteo.com/v1/marine?latitude="+norrona.position.latitude+"&longitude="+norrona.position.longitude+"&current=wave_height").then(function(r){return r.json()}).then(function(d) {
                    if(document.getElementById("wave-height")) document.getElementById("wave-height").textContent = d.current.wave_height ? d.current.wave_height.toFixed(1) : "--";
                }).catch(function(e){});
            }

            fetch("https://api.open-meteo.com/v1/forecast?latitude="+currentDestInfo.lat+"&longitude="+currentDestInfo.lon+"&current=temperature_2m,weathercode").then(function(r){return r.json()}).then(function(d) {
                if(document.getElementById("weather-temp")) document.getElementById("weather-temp").textContent = Math.round(d.current.temperature_2m) + "°C";
                var codeMap = { 0:{d:'Clear',i:'01d'}, 1:{d:'Mainly clear',i:'02d'}, 2:{d:'Partly cloudy',i:'03d'}, 3:{d:'Overcast',i:'04d'}, 45:{d:'Fog',i:'50d'}, 51:{d:'Drizzle',i:'09d'}, 61:{d:'Rain',i:'10d'}, 71:{d:'Snow',i:'13d'}, 80:{d:'Showers',i:'09d'}, 95:{d:'Storm',i:'11d'} };
                var w = codeMap[d.current.weathercode] || {d:'Unknown', i:'01d'};
                if(document.getElementById("weather-description")) document.getElementById("weather-description").textContent = w.d;
                var iconImg = document.getElementById("weather-icon");
                if(iconImg) {
                    iconImg.src = "https://openweathermap.org/img/wn/" + w.i + "@2x.png";
                    iconImg.style.display = "block"; 
                }
            }).catch(function(e){});

            if (map && norrona.position) {
                var shipPos = [norrona.position.latitude, norrona.position.longitude]; 
                var destPos = [currentDestInfo.lat, currentDestInfo.lon];
                if (!map.shipMarker) { 
                    var svg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FCB900" stroke="#002836" stroke-width="2" stroke-linejoin="round"><path d="M12 2L19 21L12 17L5 21L12 2Z"/></svg>';
                    var icon = L.divIcon({ className: 'ship-marker-container', html: '<div style="transform: rotate('+course+'deg); width: 30px; height: 30px;">'+svg+'</div>', iconSize: [30, 30], iconAnchor: [15, 15] });
                    map.shipMarker = L.marker(shipPos, { icon: icon }).addTo(map); 
                } else { 
                    map.shipMarker.setLatLng(shipPos);
                    var svg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FCB900" stroke="#002836" stroke-width="2" stroke-linejoin="round"><path d="M12 2L19 21L12 17L5 21L12 2Z"/></svg>';
                    var newIcon = L.divIcon({ className: 'ship-marker-container', html: '<div style="transform: rotate('+course+'deg); width: 30px; height: 30px;">'+svg+'</div>', iconSize: [30, 30], iconAnchor: [15, 15] });
                    map.shipMarker.setIcon(newIcon);
                }

                if (!isInPort) {
                    var pinIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', iconSize: [25, 41], iconAnchor: [12, 41] });
                    if (!map.destMarker) map.destMarker = L.marker(destPos, {icon: pinIcon}).addTo(map); else map.destMarker.setLatLng(destPos);
                    if (liveRouteLine) map.removeLayer(liveRouteLine); 
                    liveRouteLine = L.polyline([shipPos, destPos], { color: '#004A59', weight: 3, dashArray: '10, 10' }).addTo(map);
                    map.fitBounds(L.latLngBounds(shipPos, destPos), { padding: [20, 20] });
                } else {
                    if (map.destMarker) { map.removeLayer(map.destMarker); map.destMarker = null; }
                    if (liveRouteLine) { map.removeLayer(liveRouteLine); liveRouteLine = null; }
                    map.setView(shipPos, 14);
                }
            }
        } catch(e) { console.error("Data error", e); }
    }

    function initializeVoyagePage() {
        if(!document.getElementById("map")) return;
        map = L.map("map", { zoomControl: false, attributionControl: false }).setView([62.0, -6.7], 5);
        L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", { subdomains: "abcd" }).addTo(map);
        var route = [[57.59, 9.96], [57.80, 8.90], [58.20, 5.50], [59.50, 2.00],[60.85, -0.83], [61.50, -3.50], [62.01, -6.77], [62.50, -8.00],[64.00, -11.50], [65.10, -13.00], [65.26, -14.01]];
        L.polyline(route, { color: '#ffffff', weight: 1, dashArray: '5, 15', opacity: 0.2 }).addTo(map);
        updateShipData();
        setInterval(updateShipData, 60000); 
    }
</script>

</body>
</html>

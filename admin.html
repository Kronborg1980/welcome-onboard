<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Norröna Admin - Secure Login</title>
    
    <link rel="icon" type="image/svg+xml" href="https://www.smyrilline.com/wp-content/themes/lunnar-smyrilline/images/logo.svg">
    <link href="https://unpkg.com/material-icons@1.13.12/iconfont/material-icons.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        :root { 
            --primary-navy: #002836; 
            --primary-blue: #004A59;
            --accent-gold: #fbb900; 
            --bg-light: #f4f6f8;
            --text-dark: #1a202c; 
            --text-muted: #637381; 
            --border-light: #dfe3e8; 
            --danger: #e74c3c; 
            --success: #2ecc71; 
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { display: flex; height: 100vh; background-color: var(--bg-light); color: var(--text-dark); overflow: hidden; }
        
        /* --- LOGIN SCREEN --- */
        #login-screen { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 9999; background: var(--primary-navy); transition: 0.5s; }
        .login-box { background: #fff; padding: 40px; border-radius: 16px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .login-box img { width: 150px; margin-bottom: 20px; }
        .login-box h2 { margin-bottom: 25px; color: var(--primary-navy); font-size: 1.5rem; }
        .login-box input { width: 100%; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 1rem; }
        .login-box input:focus { outline: none; border-color: var(--primary-blue); }
        #login-error { color: var(--danger); font-size: 0.9rem; margin-bottom: 15px; display: none; }
        
        /* --- APP UI --- */
        #admin-app { display: none; width: 100%; height: 100%; }
        aside { width: 280px; background: var(--primary-navy); color: #fff; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 1.2rem; }
        .sidebar-header .dot { width: 10px; height: 10px; background: var(--success); border-radius: 50%; }
        .sidebar-nav { flex: 1; overflow-y: auto; padding: 15px 0; }
        .nav-group { margin-bottom: 20px; }
        .nav-title { padding: 0 20px; font-size: 0.8rem; text-transform: uppercase; color: rgba(255,255,255,0.5); margin-bottom: 10px; letter-spacing: 1px; font-weight: 700; }
        .nav-item { padding: 12px 20px; display: flex; align-items: center; gap: 12px; color: rgba(255,255,255,0.8); text-decoration: none; cursor: pointer; transition: 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active { background: rgba(255,255,255,0.1); border-left-color: var(--accent-gold); color: #fff; font-weight: bold; }
        
        main { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { height: 70px; border-bottom: 1px solid var(--border-light); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; background: #fff; }
        .content-area { flex: 1; padding: 30px; overflow-y: auto; }
        h2 { margin-bottom: 20px; font-weight: 700; color: var(--primary-navy); display: flex; align-items: center; justify-content: space-between; }
        
        .card { background: #fff; border: 1px solid var(--border-light); border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; font-weight: 600; color: var(--text-dark); }
        input[type="text"], input[type="url"], textarea, select { width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 1rem; transition: 0.2s; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary-blue); }
        textarea { resize: vertical; min-height: 100px; font-family: monospace; font-size: 0.9rem; }
        
        .btn { padding: 12px 24px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 1rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--accent-gold); color: var(--primary-navy); }
        .btn-primary:hover { background: #e5a800; }
        .btn-danger { background: #fce8e6; color: var(--danger); }
        .btn-outline { background: #fff; border: 1px solid var(--border-light); color: var(--primary-navy); }
        .btn-outline:hover { background: var(--bg-light); }
        
        .toast { position: fixed; bottom: 30px; right: 30px; background: var(--success); color: #fff; padding: 15px 25px; border-radius: 8px; font-weight: bold; transform: translateY(100px); opacity: 0; transition: 0.3s; z-index: 9999; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .option-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .option-row input { flex: 1; }
        .option-row button { padding: 8px; background: transparent; color: var(--danger); border: none; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <img src="https://www.smyrilline.com/wp-content/themes/lunnar-smyrilline/images/logo.svg" alt="Smyril Line">
            <h2>Admin Login</h2>
            <div id="login-error">Invalid Email or Password.</div>
            <input type="email" id="auth-email" placeholder="Email Address" autocomplete="email">
            <input type="password" id="auth-password" placeholder="Password">
            <button class="btn btn-primary" style="width: 100%; border-radius: 8px;" onclick="loginAdmin()">Secure Login</button>
        </div>
    </div>

    <div id="admin-app">
        <aside>
            <div class="sidebar-header">
                <div class="dot"></div> LIVE ADMIN
            </div>
            <div class="sidebar-nav">
                <div class="nav-group">
                    <div class="nav-title">Ship Handbook</div>
                    <div class="nav-item active" onclick="loadEditor('handbook', 'general', this)"><span class="material-icons">public</span> General Rules</div>
                    <div class="nav-item" onclick="loadEditor('handbook', 'hotel', this)"><span class="material-icons">room_service</span> Hotel Dept.</div>
                    <div class="nav-item" onclick="loadEditor('handbook', 'bridge_engine', this)"><span class="material-icons">engineering</span> Bridge & Engine</div>
                </div>
                <div class="nav-group">
                    <div class="nav-title">Quizzes</div>
                    <div class="nav-item" onclick="loadEditor('quiz', 'universal', this)"><span class="material-icons">quiz</span> Universal</div>
                    <div class="nav-item" onclick="loadEditor('quiz', 'Deck', this)"><span class="material-icons">anchor</span> Deck Ops</div>
                    <div class="nav-item" onclick="loadEditor('quiz', 'Engine', this)"><span class="material-icons">settings</span> Engine Room</div>
                    <div class="nav-item" onclick="loadEditor('quiz', 'Galley', this)"><span class="material-icons">restaurant</span> Galley</div>
                    <div class="nav-item" onclick="loadEditor('quiz', 'Shop', this)"><span class="material-icons">storefront</span> Tax-Free Shop</div>
                    <div class="nav-item" onclick="loadEditor('quiz', 'Reception', this)"><span class="material-icons">desk</span> Reception</div>
                    <div class="nav-item" onclick="loadEditor('quiz', 'Restaurant_Bar', this)"><span class="material-icons">local_bar</span> Rest/Bar</div>
                    <div class="nav-item" onclick="loadEditor('quiz', 'Housekeeping', this)"><span class="material-icons">cleaning_services</span> Housekeeping</div>
                </div>
                <div class="nav-group">
                    <div class="nav-title">System</div>
                    <div class="nav-item" onclick="loadEditor('system', 'settings', this)"><span class="material-icons">settings_applications</span> Settings</div>
                    <div class="nav-item" style="color: #ff8a80;" onclick="logoutAdmin()"><span class="material-icons">logout</span> Secure Logout</div>
                </div>
            </div>
        </aside>

        <main>
            <header>
                <div>
                    <span style="color:var(--text-muted);">Editing: </span> 
                    <strong id="header-title" style="color:var(--primary-navy); font-size:1.1rem;">Loading...</strong>
                </div>
                <button class="btn btn-primary" onclick="saveToFirebase()"><span class="material-icons">cloud_upload</span> Sync to Live App</button>
            </header>
            <div class="content-area" id="editor-container">
                <h2 style="color: var(--text-muted); text-align:center; width:100%; margin-top:50px;">Connecting to Firebase...</h2>
            </div>
        </main>
    </div>

    <div class="toast" id="toast">Live App Updated Successfully!</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSy" + "D1C2qR2CR5LPA2tps8b9_cO9WNt13iDqc",
        authDomain: "norrona-app.firebaseapp.com",
        databaseURL: "https://norrona-app-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "norrona-app",
        storageBucket: "norrona-app.firebasestorage.app",
        messagingSenderId: "836610543277",
        appId: "1:836610543277:web:3e74479daf205453bd0024"
    };
    
    try {
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    } catch(e) {
        document.getElementById('login-error').innerText = "Firebase failed to connect. Check Config.";
        document.getElementById('login-error').style.display = 'block';
    }

    const auth = firebase.auth();
    const db = firebase.database();

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('login-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('admin-app').style.display = 'flex';
                fetchDatabase();
            }, 500);
        } else {
            document.getElementById('admin-app').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('login-screen').style.opacity = '1';
        }
    });

    function loginAdmin() {
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-password').value;
        const errorMsg = document.getElementById('login-error');
        errorMsg.style.display = 'none';
        auth.signInWithEmailAndPassword(email, pass).catch(error => {
            errorMsg.innerText = error.message;
            errorMsg.style.display = 'block';
        });
    }

    function logoutAdmin() { auth.signOut(); }

    let appData = { handbook: {}, quizzes: {} };
    let currentEditorType = 'handbook'; 
    let currentEditorKey = 'general';

    const DEFAULT_DATA = {
        handbook: {
            general: [
                { title: "Your New Home at Sea", img: "https://www.smyrilline.com/wp-content/smush-webp/2025/04/Job-1920x1325-1.jpg.webp", video: "", content: "<p>Welcome on board the Smyril Line ferry, M/F Norröna. You will be working alongside 30 to 120 colleagues.</p>" },
                { title: "Our Safety Culture", img: "https://www.smyrilline.com/wp-content/smush-webp/2025/04/Engine_Room-56_1920x1325-1600x1104.jpg.webp", video: "", content: "<div class='callout'><h4>If you see it, you own it.</h4><p>We aspire to have a proactive safety culture. If you see a safety issue, you have the responsibility to correct it immediately and report it.</p></div>" }
            ],
            hotel: [
                { title: "Hotel Department Rules", img: "https://www.smyrilline.com/wp-content/smush-webp/2025/04/QQL8303-1920x1325-1-1600x1104.jpg.webp", video: "", content: "<p><strong>Footwear:</strong> Black, comfortable, non-slippery shoes closed at the toes. MUST be all black. Worn with black socks.</p>" },
                { title: "How to Treat Guests", img: "https://www.smyrilline.com/wp-content/smush-webp/2025/04/QQL8508-1920x1325-1-1600x1104.jpg.webp", video: "", content: "<div class='callout'><h4>The 60-Second Rule</h4><p>Acknowledge and greet guests within 60 seconds. If busy, say: 'Please take a seat and I will be with you in a minute.'</p></div>" }
            ],
            bridge_engine: [
                { title: "Bridge & Engine Operations", img: "https://www.smyrilline.com/wp-content/smush-webp/2025/04/Deck-56_1920x1325-1600x1104.jpg.webp", video: "", content: "<h3>Certificates</h3><p>Smyril Line pays for required certificates. <strong>It is your own responsibility to sign up for a course before expiration.</strong></p>" }
            ]
        },
        quizzes: {
            universal: [ { q: "What does the SAFIR system handle?", options: ["Food supplies", "Passenger tickets", "Reporting accidents & near misses"], ans: 2 } ],
            Deck: [ { q: "When are hazards greatest for Deck ops?", options: ["Open ocean", "Loading and unloading", "Drills"], ans: 1 } ],
            Engine: [ { q: "What is non-negotiable in the engine room?", options: ["Tie", "Hearing protection and PPE", "Running"], ans: 1 } ],
            Galley: [ { q: "Jewelry rules in galley?", options: ["Allowed", "Restricted due to hygiene", "Only watches"], ans: 1 } ],
            Shop: [ { q: "When can crew purchase from Tax-Free?", options: ["Anytime", "Only during Crew Sale slots", "Never"], ans: 1 } ],
            Reception: [ { q: "The 60-Second Rule?", options: ["Clean desk in 60s", "Greet guests within 60s", "Answer phone in 60s"], ans: 1 } ],
            Restaurant_Bar: [ { q: "The 60-Second Rule?", options: ["Serve drinks in 60s", "Greet guests within 60s", "Clean tables in 60s"], ans: 1 } ],
            Housekeeping: [ { q: "Footwear required?", options: ["Running shoes", "Black, closed-toe, non-slip", "Slippers"], ans: 1 } ]
        }
    };

    function fetchDatabase() {
        db.ref('appData').once('value').then((snapshot) => {
            if (snapshot.exists()) { appData = snapshot.val(); } 
            else { appData = JSON.parse(JSON.stringify(DEFAULT_DATA)); }
            loadEditor('handbook', 'general', document.querySelector('.nav-item')); 
        }).catch(error => alert("Firebase Error: " + error.message));
    }

    function saveToFirebase() {
        if(currentEditorType !== 'system') extractFormData(); 
        db.ref('appData').set(appData).then(() => showToast()).catch(err => alert("Save failed: " + err.message));
    }

    function loadEditor(type, key, navElement) {
        if (currentEditorType !== 'system' && document.getElementById('editor-container').innerHTML !== '') extractFormData(); 
        currentEditorType = type; currentEditorKey = key;
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(navElement) navElement.classList.add('active');
        let headerText = type === 'system' ? "System Settings" : `${key.charAt(0).toUpperCase() + key.slice(1).replace('_', ' ')} ${type === 'quiz' ? 'Questions' : 'Pages'}`;
        document.getElementById('header-title').innerText = headerText;
        renderCurrentEditor();
    }

    function renderCurrentEditor() {
        const container = document.getElementById('editor-container');
        if (currentEditorType === 'handbook') renderHandbookForms(container);
        else if (currentEditorType === 'quiz') renderQuizForms(container);
        else if (currentEditorType === 'system') renderSystemForms(container);
    }

    function renderHandbookForms(container) {
        if (!appData.handbook) appData.handbook = {};
        const slides = appData.handbook[currentEditorKey] || [];
        let html = `<h2>Manage Pages <button class="btn btn-outline" onclick="addHandbookSlide()"><span class="material-icons">add</span> Add New Page</button></h2>`;
        slides.forEach((slide, idx) => {
            html += `
            <div class="card handbook-card" data-idx="${idx}">
                <div class="form-group"><label>Page Title</label><input type="text" class="input-title" value="${slide.title || ''}"></div>
                <div class="form-group"><label>Header Image URL</label><input type="url" class="input-img" placeholder="https://..." value="${slide.img || ''}"></div>
                <div class="form-group"><label>YouTube Embed Link</label><input type="url" class="input-video" placeholder="https://youtube.com/embed/..." value="${slide.video || ''}"></div>
                <div class="form-group"><label>Content (HTML)</label><textarea class="input-content">${slide.content || ''}</textarea></div>
                <div style="text-align:right;"><button class="btn btn-danger" onclick="deleteHandbookSlide(${idx})">Delete</button></div>
            </div>`;
        });
        container.innerHTML = html;
    }

    function addHandbookSlide() { extractFormData(); if(!appData.handbook[currentEditorKey]) appData.handbook[currentEditorKey] = []; appData.handbook[currentEditorKey].push({ title: "New Page", img: "", video: "", content: "<p>Content...</p>" }); renderCurrentEditor(); }
    function deleteHandbookSlide(idx) { if(confirm('Delete?')) { appData.handbook[currentEditorKey].splice(idx, 1); renderCurrentEditor(); } }

    function renderQuizForms(container) {
        if (!appData.quizzes) appData.quizzes = {};
        const questions = appData.quizzes[currentEditorKey] || [];
        let html = `<h2>Manage Questions <button class="btn btn-outline" onclick="addQuizQuestion()"><span class="material-icons">add</span> Add Question</button></h2>`;
        questions.forEach((q, idx) => {
            html += `
            <div class="card quiz-card" data-idx="${idx}">
                <div class="form-group"><label>Question</label><input type="text" class="input-q" value="${q.q || ''}"></div>
                <div class="form-group">
                    <label>Options</label>
                    <div id="options-container-${idx}">
                        ${(q.options || []).map((opt, optIdx) => `
                            <div class="option-row"><input type="text" class="input-opt" value="${opt}"><button onclick="removeQuizOption(${idx}, ${optIdx})"><span class="material-icons">close</span></button></div>
                        `).join('')}
                    </div>
                    <button class="btn btn-outline" style="padding: 5px 10px; margin-top:5px; font-size:0.8rem; border-radius:4px;" onclick="addQuizOption(${idx})">+ Add Option</button>
                </div>
                <div class="form-group">
                    <label>Correct Answer Index</label>
                    <select class="input-ans">
                        ${(q.options || []).map((opt, optIdx) => `<option value="${optIdx}" ${q.ans == optIdx ? 'selected' : ''}>Option ${optIdx + 1}: ${opt}</option>`).join('')}
                    </select>
                </div>
                <div style="text-align:right;"><button class="btn btn-danger" onclick="deleteQuizQuestion(${idx})">Delete</button></div>
            </div>`;
        });
        container.innerHTML = html;
    }

    function addQuizQuestion() { extractFormData(); if(!appData.quizzes[currentEditorKey]) appData.quizzes[currentEditorKey] = []; appData.quizzes[currentEditorKey].push({ q: "New Question?", options: ["A", "B"], ans: 0 }); renderCurrentEditor(); }
    function deleteQuizQuestion(idx) { if(confirm('Delete?')) { appData.quizzes[currentEditorKey].splice(idx, 1); renderCurrentEditor(); } }
    function addQuizOption(idx) { extractFormData(); appData.quizzes[currentEditorKey][idx].options.push("New"); renderCurrentEditor(); }
    function removeQuizOption(idx, optIdx) { extractFormData(); appData.quizzes[currentEditorKey][idx].options.splice(optIdx, 1); renderCurrentEditor(); }

    function renderSystemForms(container) {
        container.innerHTML = `
            <h2>System Settings</h2>
            <div class="card">
                <h3>Database Controls</h3>
                <p style="color:var(--text-muted); margin-bottom:15px;">Resetting will overwrite live Firebase data with defaults.</p>
                <button class="btn btn-danger" onclick="factoryReset()">Reset Database to Defaults</button>
            </div>
        `;
    }
    
    function factoryReset() { if(confirm("ERASE ALL LIVE DATA?")) { appData = JSON.parse(JSON.stringify(DEFAULT_DATA)); saveToFirebase(); renderCurrentEditor(); } }

    function extractFormData() {
        if (currentEditorType === 'handbook') {
            const cards = document.querySelectorAll('.handbook-card');
            if(!appData.handbook[currentEditorKey]) appData.handbook[currentEditorKey] = [];
            cards.forEach(card => {
                const idx = card.getAttribute('data-idx');
                appData.handbook[currentEditorKey][idx].title = card.querySelector('.input-title').value;
                appData.handbook[currentEditorKey][idx].img = card.querySelector('.input-img').value;
                appData.handbook[currentEditorKey][idx].video = card.querySelector('.input-video').value;
                appData.handbook[currentEditorKey][idx].content = card.querySelector('.input-content').value;
            });
        } else if (currentEditorType === 'quiz') {
            const cards = document.querySelectorAll('.quiz-card');
            if(!appData.quizzes[currentEditorKey]) appData.quizzes[currentEditorKey] = [];
            cards.forEach(card => {
                const idx = card.getAttribute('data-idx');
                appData.quizzes[currentEditorKey][idx].q = card.querySelector('.input-q').value;
                appData.quizzes[currentEditorKey][idx].ans = parseInt(card.querySelector('.input-ans').value);
                const optInputs = card.querySelectorAll('.input-opt');
                appData.quizzes[currentEditorKey][idx].options = [];
                optInputs.forEach(optInput => appData.quizzes[currentEditorKey][idx].options.push(optInput.value));
            });
        }
    }

    function showToast() { const t = document.getElementById('toast'); t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
</script>
</body>
</html>
